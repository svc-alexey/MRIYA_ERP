# PRD: Доработка обработки "Создание номенклатурных замен" с загрузкой из Excel

## Заголовок
Доработка функционала обработки `MRS_СозданиеНоменклатурныхЗамен` для массового создания документов `питРегистрацияЗамен` на основе данных из файла Excel с расширенным поиском номенклатуры, управлением периодом действия и выбором подразделений.

---

## Контекст & Цели

### Проблема & предпосылки
Существующая обработка `MRS_СозданиеНоменклатурныхЗамен` позволяет загружать данные из Excel для создания замен номенклатуры, однако имеет следующие ограничения:
- Поиск номенклатуры осуществляется только по наименованию
- Отсутствует возможность указать период действия замен
- Нет возможности выбрать подразделения, для которых применяются замены
- Не реализован механизм автоматического создания документов `питРегистрацияЗамен`
- Нет обратной связи о созданных документах в таблице обработки

### Objectives (цели)
- Расширить алгоритм поиска номенклатуры при загрузке из Excel (поиск по коду и наименованию)
- Добавить возможность указания периода действия замен на форме обработки
- Реализовать подбор подразделений, для которых применяются замены
- Автоматизировать создание документов `питРегистрацияЗамен` с корректным заполнением всех необходимых полей
- Обеспечить возможность перехода к созданным документам из таблицы обработки
- Обеспечить взаимозаменяемость всех материалов в одной строке Excel (один к одному)

### Non-goals / Out of scope
- Валидация корректности данных в Excel файле
- Проверка прав доступа на создание документов
- Автоматическая проводка созданных документов
- Отмена созданных документов из обработки
- Массовое редактирование уже созданных замен
- Загрузка из других форматов файлов (csv, xml и т.д.)
- Экспорт результатов в Excel

---

## Assumptions (допущения)
- Excel файл имеет структуру: первая колонка - материал, остальные колонки (1-5) - возможные замены
- Все материалы в одной строке Excel должны быть взаимозаменяемыми один к одному (коэффициент = 1)
- Пользователь имеет необходимые права на создание документов `питРегистрацияЗамен`
- Код номенклатуры уникален в справочнике `Номенклатура`
- Структура документа `питРегистрацияЗамен` не будет изменена в процессе разработки
- Характеристики номенклатуры не используются (остаются пустыми)

---

## Core functions (основной функционал)

### 1. Расширенный поиск номенклатуры при загрузке из Excel
- При обработке каждой ячейки Excel проверять значение:
  - Если значение найдено по полю `Наименование` в справочнике `Номенклатура` - использовать эту ссылку
  - Если не найдено по наименованию - попытаться найти по полю `Код` в справочнике `Номенклатура`
  - Устанавливать соответствующий флаг "Найдена" в таблице результатов
- Приоритет поиска: сначала по наименованию, затем по коду
- Игнорировать элементы с пометкой удаления

### 2. Добавление реквизитов периода действия на форму обработки
- Добавить два новых реквизита формы:
  - `ДатаДействияС` - тип `Дата`, формат `ДЛФ=Д`
  - `ДатаДействияПО` - тип `Дата`, формат `ДЛФ=Д`
- Разместить на форме в верхней части, над таблицей загруженных данных
- Поля должны быть обязательными для заполнения перед созданием документов
- По умолчанию не заполнены

### 3. Добавление подбора подразделений на форму обработки
- Добавить табличную часть формы `Подразделения` с колонками:
  - `Подразделение` - тип `СправочникСсылка.СтруктураПредприятия`
  - `ВключаяПодчиненные` - тип `Булево`
- Добавить команды:
  - "Подобрать подразделения" - открывает форму выбора элементов справочника `СтруктураПредприятия`
  - "Добавить строку"
  - "Удалить строку"
- Разместить на форме под реквизитами периода действия
- Если не указано ни одного подразделения - создавать замены для всех подразделений (не заполнять табличную часть в документе)

### 4. Добавление колонки "Ссылка на документ" в таблицу данных
- Добавить в начало табличной части `Данные` новую колонку:
  - Имя: `СсылкаНаДокумент`
  - Тип: `ДокументСсылка.питРегистрацияЗамен`
  - Редактирование: Только просмотр
  - Представление: Гиперссылка для перехода к документу
- Заполняется автоматически после создания документа
- Позволяет быстро открыть созданный документ

### 5. Реализация логики создания документов
- Серверная процедура `СоздатьАналогиНаСервере()` должна:
  - Проверить заполнение обязательных реквизитов (`ДатаДействияС`, `ДатаДействияПО`)
  - Для каждой строки таблицы `Данные` создать один документ `питРегистрацияЗамен`
  - Пропускать строки, где не найден материал (первая колонка)

### 6. Заполнение документа питРегистрацияЗамен
Для каждой строки таблицы `Данные`:
- **Реквизиты документа:**
  - `Дата` = ТекущаяДата()
  - `Номенклатура` = Номенклатура из первой колонки (Материал)
  - `Характеристика` = Пустая ссылка
  - `ДатаНачалаДействия` = `ДатаДействияС` из формы обработки
  - `ДатаОкончанияДействия` = `ДатаДействияПО` из формы обработки
  - `Комментарий` = "#Создано из EXCEL = " + Формат(ТекущаяДата(), "ДЛФ=DT")
  - `Ответственный` = ПараметрыСеанса.ТекущийПользователь

- **Табличная часть "Заменители":**
  - Для каждой найденной замены (колонки 2-6) добавить строку:
    - `Номенклатура` = Ссылка на найденную номенклатуру
    - `Характеристика` = Пустая ссылка
    - `Коэффициент` = 1
    - `Приоритет` = НомерКолонки (1, 2, 3, 4, 5)
    - `Обратимость` = Истина
    - `ИсточникОбратимости` = Неопределено

- **Табличная часть "Подразделения":**
  - Если в обработке указаны подразделения - скопировать их в документ
  - Если не указаны - оставить табличную часть пустой (замена действует для всех подразделений)

- **Действия после заполнения:**
  - Записать документ
  - Заполнить колонку `СсылкаНаДокумент` в таблице `Данные` обработки ссылкой на созданный документ
  - Вывести в конце сообщение: "Создано документов: N"

### 7. Обеспечение взаимозаменяемости материалов
**Логика создания взаимных замен:**
Для каждой строки Excel, где указано N материалов (1 основной + M замен), создается N документов:
- Документ 1: Номенклатура = Материал1, Заменители = [Материал2, Материал3, ..., МатериалN]
- Документ 2: Номенклатура = Материал2, Заменители = [Материал1, Материал3, ..., МатериалN]
- ...
- Документ N: Номенклатура = МатериалN, Заменители = [Материал1, Материал2, ..., МатериалN-1]

**Важно:** Для обеспечения полной взаимозаменяемости в ТЗ (требования к функциональности) указано, что создается один документ на строку, где основной материал - из первой колонки, а остальные - заменители. Однако для полной взаимозаменяемости "один к одному" необходимо использовать флаг `Обратимость = Истина` в табличной части "Заменители".

---

## Flows (потоки работы)

### Основной поток: Создание замен из Excel

**Шаг 1. Подготовка данных**
1. Пользователь открывает обработку `MRS_СозданиеНоменклатурныхЗамен`
2. Нажимает кнопку выбора файла Excel
3. Выбирает файл с расширением `.xlsx`
4. Система загружает файл во временное хранилище

**Шаг 2. Загрузка и разбор данных**
1. Пользователь нажимает кнопку "Прочитать файл"
2. Система читает табличный документ из Excel
3. Для каждой строки и каждой колонки:
   - Извлекает значение ячейки и приводит к строковому типу
   - Если ячейка не пустая:
     - Выполняет запрос поиска по полю `Номенклатура.Наименование`
     - Если не найдено - выполняет запрос поиска по полю `Номенклатура.Код`
     - Если найдено - заменяет строковое значение на ссылку на элемент справочника
     - Устанавливает флаг "Найдена" в соответствующей колонке
4. Заполняет табличную часть `Данные` обработки результатами

**Шаг 3. Настройка параметров создания замен**
1. Пользователь указывает период действия замен:
   - Заполняет поле `ДатаДействияС`
   - Заполняет поле `ДатаДействияПО`
2. Опционально: Пользователь добавляет подразделения:
   - Нажимает "Подобрать подразделения"
   - Выбирает нужные элементы справочника `СтруктураПредприятия`
   - При необходимости устанавливает флаг "Включая подчиненные"
3. Проверяет загруженные данные в таблице `Данные`

**Шаг 4. Создание документов**
1. Пользователь нажимает кнопку "Создать номенклатуру" (команда `СоздатьНоменклатуру`)
2. Вызывается серверная процедура `СоздатьАналогиНаСервере()`
3. Система проверяет:
   - Заполнено ли поле `ДатаДействияС` (если нет - вывести ошибку)
   - Заполнено ли поле `ДатаДействияПО` (если нет - вывести ошибку)
   - Есть ли строки в таблице `Данные` (если нет - вывести предупреждение)
4. Для каждой строки таблицы `Данные`:
   - Проверка: Найден ли материал в первой колонке (флаг `НайденМатериал = Истина`)
   - Если не найден - пропустить строку с предупреждением
   - Если найден:
     - Создать новый документ `питРегистрацияЗамен`
     - Заполнить реквизиты шапки документа
     - Заполнить табличную часть "Заменители" из колонок с найденными заменами
     - Заполнить табличную часть "Подразделения" (если указаны)
     - Записать документ
     - Сохранить ссылку на созданный документ в колонку `СсылкаНаДокумент` таблицы `Данные`
5. Вывести итоговое сообщение: "Создано документов: N"
6. Обновить отображение таблицы `Данные` (показать ссылки на документы)

**Шаг 5. Проверка созданных документов**
1. Пользователь видит в таблице `Данные` заполненную колонку `СсылкаНаДокумент`
2. Нажимает на гиперссылку в нужной строке
3. Открывается форма документа `питРегистрацияЗамен`
4. Пользователь проверяет корректность заполнения и при необходимости проводит документ

### Альтернативный поток: Номенклатура не найдена

**Условие:** При загрузке Excel одна или несколько позиций номенклатуры не найдены

1. Система выполняет загрузку файла
2. Для ячейки, где номенклатура не найдена:
   - Оставляет строковое значение в таблице
   - Не устанавливает флаг "Найдена" (оставляет Ложь)
3. Пользователь видит в таблице `Данные` строки с ненайденными позициями
4. Варианты действий:
   - **4a.** Вручную создать недостающие элементы номенклатуры, перечитать файл
   - **4b.** Вручную исправить данные в Excel, перечитать файл
   - **4c.** Продолжить создание документов только для найденных позиций

### Альтернативный поток: Не указан период действия

**Условие:** Пользователь не заполнил поля `ДатаДействияС` или `ДатаДействияПО`

1. Пользователь нажимает кнопку "Создать номенклатуру"
2. Система проверяет заполнение реквизитов
3. Если не заполнено:
   - Выводит сообщение об ошибке: "Необходимо указать период действия замен"
   - Устанавливает фокус на незаполненное поле
   - Прерывает выполнение процедуры
4. Пользователь заполняет поля и повторяет попытку

### Альтернативный поток: Материал указан, но нет ни одной замены

**Условие:** В строке Excel указан только материал в первой колонке, замены не указаны

1. Система обрабатывает строку
2. Проверка: Есть ли хотя бы одна найденная замена (флаги `НайденаЗамена1...5`)
3. Если ни одной замены не найдено:
   - Пропустить строку
   - Вывести предупреждение: "Строка N: Не указаны замены для номенклатуры [наименование]"
4. Продолжить обработку следующих строк

---

## Data & Integrations (данные и интеграции)

### Основные сущности

#### 1. Обработка: MRS_СозданиеНоменклатурныхЗамен

**Реквизиты формы (новые):**
| Имя | Тип | Обязательность | Описание |
|-----|-----|----------------|----------|
| ДатаДействияС | Дата | Да | Дата начала действия замен |
| ДатаДействияПО | Дата | Да | Дата окончания действия замен |

**Реквизиты формы (существующие):**
| Имя | Тип | Описание |
|-----|-----|----------|
| Файл | Строка | Путь к загружаемому файлу Excel |
| ТабличныйДокумент | ТабличныйДокумент | Временный табличный документ для чтения Excel |

**Табличная часть формы: Подразделения (новая):**
| Колонка | Тип | Обязательность | Описание |
|---------|-----|----------------|----------|
| Подразделение | СправочникСсылка.СтруктураПредприятия | Да | Подразделение, для которого применяется замена |
| ВключаяПодчиненные | Булево | Нет | Признак включения подчиненных подразделений |

**Табличная часть формы: Данные (модифицированная):**
| Колонка | Тип | Описание |
|---------|-----|----------|
| СсылкаНаДокумент | ДокументСсылка.питРегистрацияЗамен | Ссылка на созданный документ (новая) |
| Колонка1 | СправочникСсылка.Номенклатура / Строка | Основной материал |
| Колонка2 | СправочникСсылка.Номенклатура / Строка | Замена 1 |
| Колонка3 | СправочникСсылка.Номенклатура / Строка | Замена 2 |
| Колонка4 | СправочникСсылка.Номенклатура / Строка | Замена 3 |
| Колонка5 | СправочникСсылка.Номенклатура / Строка | Замена 4 |
| Колонка6 | СправочникСсылка.Номенклатура / Строка | Замена 5 |
| НайденМатериал | Булево | Флаг: найден ли материал в справочнике |
| НайденаЗамена1 | Булево | Флаг: найдена ли замена 1 |
| НайденаЗамена2 | Булево | Флаг: найдена ли замена 2 |
| НайденаЗамена3 | Булево | Флаг: найдена ли замена 3 |
| НайденаЗамена4 | Булево | Флаг: найдена ли замена 4 |
| НайденаЗамена5 | Булево | Флаг: найдена ли замена 5 |

#### 2. Документ: питРегистрацияЗамен (используется, без изменений)

**Реквизиты:**
| Имя | Тип | Заполнение | Описание |
|-----|-----|------------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Обязательное | Заменяемый материал |
| Характеристика | СправочникСсылка.ХарактеристикиНоменклатуры | Опционально | Характеристика заменяемого материала |
| ДатаНачалаДействия | Дата | Обязательное | Дата начала действия замены |
| ДатаОкончанияДействия | Дата | Опционально | Дата окончания действия замены |
| Комментарий | Строка (неограниченная) | Опционально | Комментарий к документу |
| Ответственный | СправочникСсылка.Пользователи | Опционально | Ответственный за регистрацию замен |
| ДокументИсточник | ДокументСсылка.питРегистрацияЗамен | Опционально | Ссылка на документ-источник |

**Табличная часть: Заменители**
| Колонка | Тип | Заполнение | Описание |
|---------|-----|------------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Обязательное | Номенклатура-заменитель |
| Характеристика | СправочникСсылка.ХарактеристикиНоменклатуры | Опционально | Характеристика заменителя |
| Коэффициент | Число (10,3) | Обязательное | Коэффициент пересчета (всегда 1) |
| Приоритет | Число (5,0) | Опционально | Приоритет замены (1-5) |
| Обратимость | Булево | Опционально | Признак обратимости замены (всегда Истина) |
| ИсточникОбратимости | ДокументСсылка.питРегистрацияЗамен | Опционально | Не заполняется |

**Табличная часть: Подразделения**
| Колонка | Тип | Заполнение | Описание |
|---------|-----|------------|----------|
| Подразделение | СправочникСсылка.СтруктураПредприятия | Обязательное | Подразделение |
| ВключаяПодчиненные | Булево | Опционально | Включая подчиненные подразделения |

#### 3. Справочник: Номенклатура (только чтение)

**Используемые поля:**
| Поле | Тип | Назначение |
|------|-----|-----------|
| Наименование | Строка | Поиск номенклатуры по наименованию |
| Код | Строка | Поиск номенклатуры по коду |
| ПометкаУдаления | Булево | Исключение удаленных элементов |
| питВидНоменклатуры | ПеречислениеСсылка | Фильтр по виду = "Товар" |

#### 4. Справочник: СтруктураПредприятия (только чтение)

**Используется для:** Выбора подразделений, для которых применяются замены

### Интеграции

#### Внешние файлы
- **Excel файлы (.xlsx):** Источник данных для загрузки
  - Ожидаемая структура: до 6 колонок (1 материал + 5 замен)
  - Первая строка может быть заголовком или данными
  - Пустые строки игнорируются

#### Регистры сведений
- **питЗаменыИнгредиентов:** Регистр, в который пишет документ `питРегистрацияЗамен` при проведении
  - Обработка не работает напрямую с регистром
  - Запись в регистр происходит при проведении документа

---

## Metadata (метаданные 1С)

### Изменения в существующих объектах

#### Обработка: MRS_СозданиеНоменклатурныхЗамен

**Форма "Форма":**

**Новые реквизиты формы:**
```
Реквизит: ДатаДействияС
  Тип: Дата
  Формат даты: Дата
  
Реквизит: ДатаДействияПО
  Тип: Дата
  Формат даты: Дата
```

**Новая табличная часть формы:**
```
Табличная часть: Подразделения
  Колонка: Подразделение
    Тип: СправочникСсылка.СтруктураПредприятия
  Колонка: ВключаяПодчиненные
    Тип: Булево
```

**Изменения в табличной части Данные:**
```
Добавить колонку в начало:
  Колонка: СсылкаНаДокумент
    Тип: ДокументСсылка.питРегистрацияЗамен
    Редактирование: Только просмотр
```

**Новые команды формы:**
```
Команда: ПодобратьПодразделения
  Действие: Открывает форму выбора элементов справочника СтруктураПредприятия
  
Команда: ДобавитьПодразделение
  Действие: Добавляет новую строку в ТЧ Подразделения
  
Команда: УдалитьПодразделение
  Действие: Удаляет текущую строку из ТЧ Подразделения
```

**Модификация существующих процедур:**
```
Процедура: ПрочитатьФайлНаСервере()
  Изменения:
  - Добавить поиск по полю Код, если поиск по Наименованию не дал результатов
  - Добавить колонку СсылкаНаДокумент в ТаблицаРезультата
  - Инициализировать СсылкаНаДокумент = Неопределено

Процедура: СоздатьАналогиНаСервере()
  Изменения:
  - Реализовать полную логику создания документов питРегистрацияЗамен
  - Добавить проверку заполнения ДатаДействияС и ДатаДействияПО
  - Создать цикл по строкам таблицы Данные
  - Для каждой строки создать документ и заполнить все поля
  - Заполнить колонку СсылкаНаДокумент ссылкой на созданный документ
  - Вывести итоговое сообщение о количестве созданных документов
```

**Новые процедуры/функции:**
```
Процедура: ПодобратьПодразделенияНаКлиенте()
  Назначение: Открывает форму подбора элементов справочника СтруктураПредприятия
  Параметры: Нет
  Возврат: Нет

Процедура: ДобавитьПодразделениеНаКлиенте()
  Назначение: Добавляет новую строку в ТЧ Подразделения
  Параметры: Нет
  Возврат: Нет

Процедура: УдалитьПодразделениеНаКлиенте()
  Назначение: Удаляет текущую строку из ТЧ Подразделения
  Параметры: Нет
  Возврат: Нет

Функция: ПроверитьЗаполнениеОбязательныхПолей()
  Назначение: Проверяет заполнение полей ДатаДействияС и ДатаДействияПО
  Параметры: Нет
  Возврат: Булево (Истина - все заполнено, Ложь - есть незаполненные)

Функция: СоздатьДокументЗамены(СтрокаТаблицы, ТабличнаяЧастьПодразделения)
  Назначение: Создает и заполняет один документ питРегистрацияЗамен
  Параметры: 
    - СтрокаТаблицы: СтрокаТаблицыЗначений - строка из таблицы Данные
    - ТабличнаяЧастьПодразделения: ТаблицаЗначений - подразделения из формы
  Возврат: ДокументСсылка.питРегистрацияЗамен - ссылка на созданный документ
```

### Документ: питРегистрацияЗамен
**Изменения:** Не требуется. Используется существующая структура.

### Примеры значений полей

**Реквизит Комментарий документа:**
```
Пример: "#Создано из EXCEL = 28.10.2024 14:35:22"
Формат: "#Создано из EXCEL = " + Формат(ТекущаяДата(), "ДЛФ=DT")
```

**Табличная часть Заменители:**
```
Строка 1:
  Номенклатура: Мука пшеничная высший сорт
  Характеристика: <пустая ссылка>
  Коэффициент: 1
  Приоритет: 1
  Обратимость: Истина
  ИсточникОбратимости: <пустая ссылка>

Строка 2:
  Номенклатура: Мука пшеничная первый сорт
  Характеристика: <пустая ссылка>
  Коэффициент: 1
  Приоритет: 2
  Обратимость: Истина
  ИсточникОбратимости: <пустая ссылка>
```

**Табличная часть Подразделения:**
```
Вариант 1 (указаны подразделения):
Строка 1:
  Подразделение: Цех № 1
  ВключаяПодчиненные: Истина

Строка 2:
  Подразделение: Цех № 2
  ВключаяПодчиненные: Ложь

Вариант 2 (не указаны - для всех):
  <Таблица пустая>
```

---

## Priorities (приоритизация требований)

### MoSCoW

#### Must Have (Обязательно должно быть)
- M1: Расширение поиска номенклатуры по коду (в дополнение к наименованию)
- M2: Добавление реквизитов `ДатаДействияС` и `ДатаДействияПО` на форму обработки
- M3: Реализация серверной процедуры `СоздатьАналогиНаСервере()` для создания документов
- M4: Заполнение реквизита `Комментарий` документа маркером "#Создано из EXCEL = [дата]"
- M5: Корректное заполнение табличной части "Заменители" с коэффициентом = 1 и обратимостью = Истина
- M6: Добавление колонки `СсылкаНаДокумент` в начало таблицы `Данные`
- M7: Проверка заполнения обязательных полей перед созданием документов

#### Should Have (Желательно иметь)
- S1: Добавление табличной части `Подразделения` на форму обработки
- S2: Команды подбора подразделений из справочника `СтруктураПредприятия`
- S3: Заполнение табличной части "Подразделения" в документе из обработки
- S4: Вывод итогового сообщения о количестве созданных документов
- S5: Гиперссылка в колонке `СсылкаНаДокумент` для быстрого перехода к документу

#### Could Have (Можно добавить)
- C1: Визуальное выделение строк с ненайденной номенклатурой (подсветка цветом)
- C2: Кнопка "Очистить данные" для быстрой очистки таблицы `Данные`
- C3: Статистика по загруженным данным (количество строк, найденных/не найденных позиций)
- C4: Возможность указать приоритеты замен вручную для каждой строки
- C5: Валидация дат (ДатаДействияПО >= ДатаДействияС)

#### Won't Have (Не будет реализовано в этой версии)
- W1: Автоматическая проводка созданных документов
- W2: Массовое редактирование созданных документов
- W3: Отмена/удаление созданных документов из обработки
- W4: Загрузка из других форматов (CSV, XML)
- W5: Экспорт результатов обратно в Excel
- W6: История загрузок и созданных документов
- W7: Проверка дублей замен перед созданием

---

## Technical Constraints (технические ограничения)

### Платформа
- 1C:Enterprise 8.3.24
- Конфигурация: ERP 2.5.17.103 (кастомизированная)
- Модули: Catering, КТ-2000

### Производительность
- Обработка должна корректно работать с файлами Excel размером до 1000 строк
- Время загрузки и разбора файла - не более 10 секунд для 1000 строк
- Время создания документов - не более 30 секунд для 1000 строк
- При большом количестве строк использовать транзакции для групповой записи

### Безопасность
- Использовать `УстановитьПривилегированныйРежим()` для записи документов (если требуется)
- Проверять права доступа пользователя на создание документов `питРегистрацияЗамен`
- Не передавать конфиденциальные данные в тексте ошибок

### Совместимость
- Обработка должна быть совместима с существующими документами `питРегистрацияЗамен`
- Не нарушать работу других обработок и документов системы
- Сохранить возможность ручного создания документов `питРегистрацияЗамен`

---

## Testing & Acceptance Criteria (критерии приемки)

### Функциональное тестирование

#### TC-1: Поиск номенклатуры по наименованию
**Предусловия:** В справочнике Номенклатура есть элемент с наименованием "Мука пшеничная"
**Шаги:**
1. Загрузить Excel файл с ячейкой "Мука пшеничная"
2. Нажать "Прочитать файл"
**Ожидаемый результат:** 
- В таблице Данные в соответствующей ячейке отображается ссылка на элемент справочника
- Флаг "Найдена" = Истина

#### TC-2: Поиск номенклатуры по коду
**Предусловия:** В справочнике Номенклатура есть элемент с кодом "00000123"
**Шаги:**
1. Загрузить Excel файл с ячейкой "00000123"
2. Нажать "Прочитать файл"
**Ожидаемый результат:**
- В таблице Данные в соответствующей ячейке отображается ссылка на элемент справочника
- Флаг "Найдена" = Истина

#### TC-3: Номенклатура не найдена
**Предусловия:** В справочнике Номенклатура нет элемента с наименованием/кодом "НЕСУЩЕСТВУЮЩИЙ"
**Шаги:**
1. Загрузить Excel файл с ячейкой "НЕСУЩЕСТВУЮЩИЙ"
2. Нажать "Прочитать файл"
**Ожидаемый результат:**
- В таблице Данные в ячейке остается строка "НЕСУЩЕСТВУЮЩИЙ"
- Флаг "Найдена" = Ложь

#### TC-4: Создание документа с минимальными данными
**Предусловия:** Загружена строка с материалом и одной заменой
**Шаги:**
1. Заполнить ДатаДействияС = 01.01.2025
2. Заполнить ДатаДействияПО = 31.12.2025
3. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Создан документ питРегистрацияЗамен
- Номенклатура = материал из первой колонки
- В ТЧ Заменители одна строка с номенклатурой из второй колонки
- ДатаНачалаДействия = 01.01.2025
- ДатаОкончанияДействия = 31.12.2025
- Комментарий содержит "#Создано из EXCEL ="
- Колонка СсылкаНаДокумент заполнена

#### TC-5: Создание документа с несколькими заменами
**Предусловия:** Загружена строка с материалом и 5 заменами
**Шаги:**
1. Заполнить даты действия
2. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Создан документ питРегистрацияЗамен
- В ТЧ Заменители 5 строк с приоритетами 1, 2, 3, 4, 5
- Все заменители имеют Коэффициент = 1 и Обратимость = Истина

#### TC-6: Создание документа с подразделениями
**Предусловия:** Загружена строка с материалом и заменой
**Шаги:**
1. Заполнить даты действия
2. Добавить подразделения: "Цех №1" (ВключаяПодчиненные = Истина), "Цех №2" (ВключаяПодчиненные = Ложь)
3. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Создан документ питРегистрацияЗамен
- В ТЧ Подразделения 2 строки: "Цех №1" (Истина), "Цех №2" (Ложь)

#### TC-7: Создание документа без подразделений
**Предусловия:** Загружена строка с материалом и заменой, подразделения не указаны
**Шаги:**
1. Заполнить даты действия
2. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Создан документ питРегистрацияЗамен
- ТЧ Подразделения пуста (замена действует для всех подразделений)

#### TC-8: Валидация незаполненной даты начала
**Предусловия:** Загружена строка с материалом и заменой
**Шаги:**
1. Оставить ДатаДействияС пустой
2. Заполнить ДатаДействияПО = 31.12.2025
3. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Выведено сообщение об ошибке: "Необходимо указать период действия замен"
- Фокус установлен на поле ДатаДействияС
- Документы не созданы

#### TC-9: Валидация незаполненной даты окончания
**Предусловия:** Загружена строка с материалом и заменой
**Шаги:**
1. Заполнить ДатаДействияС = 01.01.2025
2. Оставить ДатаДействияПО пустой
3. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Выведено сообщение об ошибке: "Необходимо указать период действия замен"
- Фокус установлен на поле ДатаДействияПО
- Документы не созданы

#### TC-10: Пропуск строки без найденного материала
**Предусловия:** Загружены 2 строки: 1-я с ненайденным материалом, 2-я с найденным
**Шаги:**
1. Заполнить даты действия
2. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Выведено предупреждение: "Строка 1: Материал не найден..."
- Создан 1 документ для 2-й строки
- Итоговое сообщение: "Создано документов: 1"

#### TC-11: Гиперссылка на созданный документ
**Предусловия:** Создан документ из обработки
**Шаги:**
1. Нажать на гиперссылку в колонке СсылкаНаДокумент
**Ожидаемый результат:**
- Открыта форма документа питРегистрацияЗамен
- Отображаются все заполненные данные

#### TC-12: Множественное создание документов
**Предусловия:** Загружено 10 строк с найденными материалами и заменами
**Шаги:**
1. Заполнить даты действия
2. Нажать "Создать номенклатуру"
**Ожидаемый результат:**
- Создано 10 документов
- Все колонки СсылкаНаДокумент заполнены
- Итоговое сообщение: "Создано документов: 10"

### Нефункциональное тестирование

#### Performance TC-1: Производительность загрузки
**Шаги:**
1. Загрузить Excel файл с 1000 строками
2. Нажать "Прочитать файл"
3. Измерить время выполнения
**Ожидаемый результат:** Время выполнения <= 10 секунд

#### Performance TC-2: Производительность создания документов
**Шаги:**
1. Загрузить Excel файл с 1000 строками
2. Заполнить даты действия
3. Нажать "Создать номенклатуру"
4. Измерить время выполнения
**Ожидаемый результат:** Время выполнения <= 30 секунд

#### Usability TC-1: Удобство формы
**Критерии:**
- Все элементы управления логически сгруппированы
- Порядок следования полей соответствует логике заполнения
- Подсказки к полям информативны
- Кнопки имеют понятные названия

---

## UI/UX Requirements (требования к интерфейсу)

### Расположение элементов на форме

**Порядок сверху вниз:**

1. **Группа "Параметры загрузки"**
   - Поле "Файл" (с кнопкой выбора)
   - Кнопка "Прочитать файл"

2. **Группа "Параметры замен"**
   - Поле "Дата действия С" (обязательное, красная звездочка)
   - Поле "Дата действия ПО" (обязательное, красная звездочка)

3. **Группа "Подразделения"**
   - Заголовок "Подразделения (если не указаны - для всех)"
   - Таблица подразделений (3-5 строк видимых)
   - Командная панель:
     - Кнопка "Подобрать"
     - Кнопка "Добавить"
     - Кнопка "Удалить"

4. **Группа "Загруженные данные"**
   - Заголовок "Загруженные данные"
   - Таблица данных (основная, занимает большую часть формы)

5. **Командная панель**
   - Кнопка "Создать номенклатуру" (основная кнопка, выделена)
   - Кнопка "Закрыть"

### Оформление таблицы данных

**Колонки (слева направо):**
1. СсылкаНаДокумент - "Документ" (ширина 150)
2. Колонка1 - "Материал" (ширина 250, основная колонка)
3. Колонка2 - "Замена 1" (ширина 200)
4. Колонка3 - "Замена 2" (ширина 200)
5. Колонка4 - "Замена 3" (ширина 200)
6. Колонка5 - "Замена 4" (ширина 200)
7. Колонка6 - "Замена 5" (ширина 200)

**Колонки-флаги (скрытые или минимальной ширины):**
- НайденМатериал, НайденаЗамена1-5 (можно скрыть или оставить для отладки)

**Цветовое оформление (опционально):**
- Строки с ненайденным материалом - подсветка розовым
- Ячейки с ненайденными заменами - подсветка желтым
- Заполненная колонка СсылкаНаДокумент - подсветка зеленым

### Сообщения пользователю

**Информационные сообщения:**
- "Файл успешно загружен. Строк обработано: N"
- "Создано документов: N"
- "Найдена номенклатура для: [наименование] в колонке [имя колонки] - [ссылка]"

**Предупреждения:**
- "Строка N: Не указаны замены для номенклатуры [наименование]"
- "Строка N: Материал не найден в справочнике: [значение]"
- "Нет данных для создания документов"

**Ошибки:**
- "Необходимо указать период действия замен"
- "Не выбран файл для загрузки"
- "Ошибка чтения файла: [текст ошибки]"
- "Ошибка создания документа в строке N: [текст ошибки]"

---

## Open Questions (открытые вопросы)

1. **Обработка дублей:**
   - Что делать, если в справочнике Номенклатура есть несколько элементов с одинаковым наименованием или кодом?
   - **Предложение:** Брать первый найденный элемент, выводить предупреждение

2. **Валидация дат:**
   - Нужна ли проверка, что ДатаДействияПО >= ДатаДействияС?
   - **Предложение:** Да, добавить проверку (приоритет Could Have)

3. **Повторная загрузка:**
   - Что происходит при повторном нажатии "Прочитать файл"?
   - **Предложение:** Очищать предыдущие данные и загружать новые

4. **Повторное создание:**
   - Можно ли повторно нажать "Создать номенклатуру" после успешного создания?
   - **Предложение:** Да, но предупреждать о дублировании документов

5. **Проверка существующих замен:**
   - Нужно ли проверять, что такая замена уже зарегистрирована в системе?
   - **Предложение:** Нет в текущей версии (Won't Have), но можно добавить позже

6. **Характеристики номенклатуры:**
   - Будут ли использоваться характеристики номенклатуры?
   - **Предложение:** Нет, всегда оставлять пустыми ссылками

7. **Формат Excel:**
   - Должна ли первая строка Excel быть заголовком или может содержать данные?
   - **Предложение:** Может содержать данные, заголовки не обязательны

8. **Автопроводка:**
   - Нужно ли автоматически проводить созданные документы?
   - **Предложение:** Нет (Won't Have), пользователь проводит вручную

---

## Success Metrics (метрики успеха)

### Функциональные метрики
- 100% созданных документов корректно заполнены согласно требованиям
- 0% ошибок при загрузке валидных Excel файлов
- 95%+ успешного поиска номенклатуры (по наименованию или коду) при корректных данных

### Производительность
- Время загрузки файла 1000 строк <= 10 секунд
- Время создания 1000 документов <= 30 секунд
- Отсутствие зависаний интерфейса при обработке данных

### Удобство использования
- Пользователь может создать 100 замен за 5-7 минут (включая подготовку Excel)
- Сокращение времени создания замен в 10+ раз по сравнению с ручным вводом
- Положительная обратная связь от пользователей (опрос после внедрения)

---

## Risks & Mitigation (риски и их снижение)

| Риск | Вероятность | Влияние | Меры по снижению |
|------|-------------|---------|-------------------|
| Несовместимость формата Excel (старые версии) | Средняя | Высокое | Явно указать требование .xlsx, проверить на разных версиях Excel |
| Дублирование документов при повторном создании | Высокая | Среднее | Добавить предупреждение, очищать колонку СсылкаНаДокумент при перечитывании файла |
| Низкая производительность на больших файлах | Средняя | Среднее | Использовать пакетную запись, оптимизировать запросы |
| Некорректное распознавание кодов-чисел (форматирование Excel) | Высокая | Среднее | Приводить все значения к строке с форматом "ЧГ=" |
| Потеря данных при зависании обработки | Низкая | Высокое | Использовать транзакции, логировать процесс |
| Конфликт имен колонок (Колонка1, Колонка2...) | Низкая | Низкое | Использовать динамические имена из Excel или зафиксировать соглашение |

---

## Changelog (история изменений)

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 28.10.2024 | Product Manager | Первая версия PRD |

---

## Approval (согласование)

**Требуется согласование:**
- [ ] Product Owner
- [ ] Lead Developer (1C)
- [ ] QA Lead
- [ ] Key Users (Технологи/Кладовщики)

**Дата начала разработки:** TBD
**Планируемая дата релиза:** TBD

---

## Notes (дополнительные заметки)

- При реализации обратить особое внимание на производительность запросов поиска номенклатуры
- Рекомендуется создать индекс по полю `Код` в справочнике `Номенклатура` для ускорения поиска
- После внедрения провести обучение пользователей (1-2 часа)
- Подготовить шаблон Excel файла с примером заполнения для пользователей
- Рассмотреть возможность добавления функции экспорта существующих замен в Excel в будущих версиях
