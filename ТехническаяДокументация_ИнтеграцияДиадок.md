# Техническая документация: Интеграция с Диадок

## Оглавление

1. [Общие сведения](#общие-сведения)
2. [Архитектура решения](#архитектура-решения)
3. [Компоненты системы](#компоненты-системы)
4. [API и методы](#api-и-методы)
5. [Структуры данных](#структуры-данных)
6. [Процессы работы](#процессы-работы)
7. [Настройка и конфигурация](#настройка-и-конфигурация)
8. [Обработка ошибок](#обработка-ошибок)

---

## Общие сведения

### Назначение

Модуль интеграции с сервисом электронного документооборота **Диадок** для платформы 1С:Предприятие 8.3. Решение обеспечивает:

- Получение статусов документов из Диадок
- Переход к документам в веб-интерфейсе Диадок
- Отображение статусов ЭДО в интерфейсе системы
- Аутентификацию и авторизацию пользователей

### Технический стек

- **Платформа**: 1С:Предприятие 8.3
- **API Диадок**: HTTP REST API
- **Протокол**: HTTPS
- **Формат данных**: JSON
- **Аутентификация**: DiadocAuth (логин/пароль + API ключ)

### Базовые URL

- **API**: `https://diadoc-api.kontur.ru`
- **Web-интерфейс**: `https://diadoc.kontur.ru`

---

## Архитектура решения

### Трехуровневая архитектура

Решение построено по трехуровневой архитектуре:

```
┌─────────────────────────────────────────┐
│         Клиентский уровень              │
│   (MRS_ИнтеграцияДиадокКлиент)         │
│   - Обработка действий пользователя     │
│   - Управление UI                       │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Клиент-Серверный уровень           │
│  (MRS_ИнтеграцияДиадокКлиентСервер)    │
│   - Утилиты конвертации                 │
│   - Формирование UI элементов           │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         Серверный уровень               │
│    (MRS_ИнтеграцияДиадокСервер)        │
│   - HTTP запросы к API                  │
│   - Работа с базой данных               │
│   - Бизнес-логика                       │
└─────────────────────────────────────────┘
```

### Компоненты по уровням

#### Клиентский уровень
- Формы документов (ПриобретениеТоваровУслуг)
- Формы списков (ЖурналДокументовЗакупки)
- Форма аутентификации (ФормаЗапросаДанныхДиадока)

#### Серверный уровень
- Параметры сеанса (ЛогинДиадок, ПарольДиадок, КлючРазработчикаДиадок)
- Регистр сведений (ДополнительныеСведения)
- План видов характеристик (ДополнительныеРеквизитыИСведения)

---

## Компоненты системы

### 1. Общие модули

#### MRS_ИнтеграцияДиадокКлиент

**Назначение**: Клиентская логика интеграции

**Основные функции**:
- `ПерейтиКДокументуДиадок(Форма, Документ)` - Переход к документу в веб-интерфейсе
- `ПолучитьСтатусДокументаДиадок(Форма, Документ)` - Получение статуса документа
- `ПроверитьДанныеАвторизации(Логин, Пароль)` - Проверка учетных данных

**Особенности**:
- Управление оповещениями после ввода учетных данных
- Поддержка массового получения статусов
- Кэширование параметров сеанса

#### MRS_ИнтеграцияДиадокКлиентСервер

**Назначение**: Общие утилиты и функции конвертации

**Основные функции**:
- `ДополнитьФормуИнтеграциейДиадок(Форма, ИмяТаблицыДокументов)` - Динамическое добавление элементов UI
- `АдресЯщикаВИдентификатор(АдресЯщика)` - Преобразование адреса в GUID
- `СформироватьСсылкуВБраузере(BoxId, LetterId, DocumentId)` - Формирование URL
- `Base64_2_GUID(Base64)` - Конвертация Base64 в GUID

**Вспомогательные функции**:
- `ПодставитьПараметрыВСтроку()` - Шаблонизация строк
- `Convert_Base64_to_Binary()` - Base64 → Binary
- `Convert_Binary_to_Hex()` - Binary → Hex
- `Convert_Hex_to_GUID()` - Hex → GUID

#### MRS_ИнтеграцияДиадокСервер

**Назначение**: Серверная логика и работа с API

**Основные функции**:
- `ПроверитьДанныеАвторизации(Логин, Пароль)` - Аутентификация через API
- `ПолучитьСтруктуруДокументаПоAPIДиадок()` - Получение данных документа
- `ПолучитьСсылкуНаДокументДиадок()` - Формирование ссылки
- `СохранитьСтатусДокумента(Статус, Документ)` - Сохранение в БД
- `ПолучитьСтатусДокумента(Документ)` - Чтение из БД

**Работа с параметрами сеанса**:
- `ПолучитьЛогинДиадок()`
- `ПолучитьПарольДиадок()`
- `ПолучитьКлючРазработчикаДиадок()`
- `УстановитьПараметрСеанса(ИмяПараметра, Значение)`

### 2. Формы

#### ФормаЗапросаДанныхДиадока

**Путь**: `CommonForms/ФормаЗапросаДанныхДиадока`

**Назначение**: Модальная форма для ввода учетных данных Диадок

**Реквизиты формы**:
- `ЛогинНаСайтДиадок` (Строка)
- `ПарольНаСайтДиадок` (Строка)
- `ddauth_api_client` (Строка, только чтение)

**Команды**:
- `Ок` - Проверка данных и возврат результата

**Возвращаемое значение** (Структура):
```bsl
СтруктураВозврата = Новый Структура;
СтруктураВозврата.Вставить("Логин", ЛогинНаСайтДиадок);
СтруктураВозврата.Вставить("Пароль", ПарольНаСайтДиадок);
СтруктураВозврата.Вставить("КлючРазработчикаДиадок", ddauth_api_client);
```

#### Форма документа ПриобретениеТоваровУслуг

**Расширение**: `Documents/ПриобретениеТоваровУслуг/Forms/ФормаДокумента`

**Добавленные элементы**:
- Реквизит `СтатусДиадок` (Строка, 250)
- Группа `ГруппаДиадок` (после поля Комментарий)
- Кнопка `КнопкаДиадокПерейти` - Переход в Диадок
- Кнопка `КнопкаДиадокПолучитьСтатус` - Обновление статуса
- Поле `ПолеСтатусДиадок` - Отображение статуса

**Обработчики**:
- `MRS_ПриСозданииНаСервере()` - Инициализация интеграции
- `ДиадокПерейтиВЛичныйКабинет()` - Переход к документу
- `ДиадокПолучитьСтатус()` - Получение статуса

#### Форма списка ЖурналДокументовЗакупки

**Расширение**: `DataProcessors/ЖурналДокументовЗакупки/Forms/СписокДокументов`

**Добавленные элементы**:
- Колонка `СозданВДиадок` (Булево, флажок)
- Колонка `СтатусЭДО` (Строка, отображение в списке)
- Группа кнопок `ГруппаДиадок` (после ГруппаОрганайзер)

**Модифицированный запрос**:
```sql
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК ДатаПолучСтатуса
  ПО РеестрДокументов.Ссылка = ДатаПолучСтатуса.Объект
    И (ДатаПолучСтатуса.Свойство.ИдентификаторДляФормул = "ДатаПолученияСтатуса")
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК Статус_Диадок
  ПО РеестрДокументов.Ссылка = Статус_Диадок.Объект
    И (Статус_Диадок.Свойство.ИдентификаторДляФормул = "СтатусДиадок")
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК ДополнительныеСведения
  ПО РеестрДокументов.Ссылка = ДополнительныеСведения.Объект
    И (ДополнительныеСведения.Свойство.ИдентификаторДляФормул = "ИдентификаторЯщикДокументаВДиадок")
```

### 3. Регистры и справочники

#### РегистрСведений.ДополнительныеСведения

**Назначение**: Хранение метаданных документов Диадок

**Ключевые записи** (по `ИдентификаторДляФормул`):
- `ДатаПолученияСтатуса` - Дата последнего обновления статуса
- `СтатусДиадок` - Текущий статус документа в Диадок
- `ИдентификаторДокументаВДиадок` - Base64 идентификатор документа
- `ИдентификаторЯщикДокументаВДиадок` - Идентификатор ящика

#### Параметры сеанса

- `ЛогинДиадок` (Строка) - Логин пользователя
- `ПарольДиадок` (Строка) - Пароль пользователя
- `КлючРазработчикаДиадок` (Строка) - API ключ

**Ключ по умолчанию**:
```
1C
```

---

## API и методы

### Аутентификация

#### POST /Authenticate

**Назначение**: Получение токена для доступа к API

**Параметры запроса**:
- `login` - Логин пользователя
- `password` - Пароль пользователя

**Заголовки**:
```http
POST /Authenticate?login={login}&password={password} HTTP/1.1
Host: diadoc-api.kontur.ru
Content-Length: 0
Authorization: DiadocAuth ddauth_api_client_id={api_key}
```

**Ответ**: Токен в теле ответа (строка)

**Пример кода**:
```bsl
АдресРесурса = "/Authenticate?login=" + ЛогинНаСайтДиадок + "&password=" + ПарольНаСайтДиадок;
АдресСайта = "diadoc-api.kontur.ru";

HTTPЗапрос = Новый HTTPЗапрос;
HTTPЗапрос.Заголовки.Вставить("POST " + АдресРесурса + " HTTP/1.1");
HTTPЗапрос.Заголовки.Вставить("Host", АдресСайта);
HTTPЗапрос.Заголовки.Вставить("Content-Length", 0);
HTTPЗапрос.Заголовки.Вставить("Authorization", "DiadocAuth ddauth_api_client_id=" + КлючРазработчика);
HTTPЗапрос.АдресРесурса = АдресРесурса;

Соединение = Новый HTTPСоединение(АдресСайта, , , , , 60, Новый ЗащищенноеСоединениеOpenSSL(), Ложь);
```

### Получение документа

#### GET /V3/GetDocument

**Назначение**: Получение полной информации о документе

**Параметры запроса**:
- `boxId` - Идентификатор ящика (GUID)
- `messageId` - Идентификатор сообщения (GUID)
- `entityId` - Идентификатор сущности (GUID)

**Заголовки**:
```http
GET /V3/GetDocument HTTP/1.1
Host: diadoc-api.kontur.ru
Accept: application/json
Content-Type: application/json; charset=utf-8
Authorization: DiadocAuth ddauth_api_client_id={api_key},ddauth_token={token}
```

**Структура ответа** (JSON):
```json
{
  "RecipientReceiptMetadata": {
    "ReceiptStatus": "Finished"
  },
  "DocflowStatus": {
    "PrimaryStatus": {
      "StatusText": "Документооборот завершен"
    }
  }
}
```

**Пример кода**:
```bsl
boxId = ПолучитьИдентификаторЯщикаДокумента(Документ);
Гуид = ПолучитьИдентификаторДокумента(Документ);
messageId = Лев(Гуид, 36);
entityId = СтрЗаменить(Гуид, messageId, "");

АдресСайта = "diadoc-api.kontur.ru/V3/GetDocument?boxId=" + boxId + "&messageId=" + messageId + "&entityId=" + entityId;

HTTPЗапрос = Новый HTTPЗапрос;
HTTPЗапрос.Заголовки.Вставить("Accept", "application/json");
HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
HTTPЗапрос.Заголовки.Вставить("Authorization", "DiadocAuth ddauth_api_client_id=" + КлючРазработчика + ",ddauth_token=" + Токен);
```

---

## Структуры данных

### Статусы документов

#### Соответствие статусов API

| Код статуса | Текстовое представление |
|-------------|------------------------|
| `RevocationAccepted` | Аннулирован |
| `Finished` | Документооборот завершен |
| `RevocationIsRequestedByMe` | Ожидается аннулирование |
| `InvalidSenderSignature` | Ошибка подписи |
| `RoamingNotificationError` | Ошибка доставки документа через роуминг |
| `WithRecipientSignature` | Подписан контрагентом |
| `RequestsMyRevocation` | Требуется аннулирование |
| `HaveToCreateReceipt` | Требуется подписать извещение |
| `InvoiceAmendmentRequested` | Требуется уточнение |
| `RecipientSignatureRequestRejected` | Отказано в подписи контрагенту |
| `WaitingForRecipientSignature` | Требуется подпись |
| `WaitingForReceipt` | Ожидается извещение о получении |
| `WaitingForProxySignature` | Ожидается промежуточная подпись |
| `ProxySignatureRejected` | Отказано в промежуточной подписи |

### Идентификаторы

#### Формат GUID документа

Идентификатор документа хранится в формате:
```
{messageId}-{entityId}
```

Где:
- `messageId` - GUID сообщения (36 символов)
- `entityId` - GUID сущности (36 символов)

Общая длина: 72 символа (с разделителем)

#### Формат адреса ящика

Возможные форматы:
1. Email-подобный: `{guid}@diadoc.ru`
2. GUID без дефисов: `00000000000000000000000000000000` (32 символа)
3. GUID с дефисами: `00000000-0000-0000-0000-000000000000` (36 символов)

Функция конвертации:
```bsl
Функция АдресЯщикаВИдентификатор(АдресЯщика)
    АдресЯщикаБезПробелов = СокрЛП(АдресЯщика);
    ИД = СтрЗаменить(АдресЯщикаБезПробелов, "@diadoc.ru", "");
    ДлинаИД = СтрДлина(ИД);
    
    Если ДлинаИД = 32 Тогда
        // Преобразование в формат с дефисами
        Результат = Сред(ИД, 1, 8) + "-" + Сред(ИД, 9, 4) + "-" + 
                    Сред(ИД, 13, 4) + "-" + Сред(ИД, 17, 4) + "-" + 
                    Сред(ИД, 21, 12);
    ИначеЕсли ДлинаИД = 36 Тогда
        Результат = ИД;
    Иначе
        ВызватьИсключение "Некорректный адрес ящика";
    КонецЕсли;
    
    Возврат Результат;
КонецФункции
```

### Конвертация Base64 → GUID

Идентификаторы в регистре `ДополнительныеСведения` хранятся в формате Base64 и требуют конвертации:

**Этапы конвертации**:
1. Base64 → Binary (строка из 0 и 1)
2. Binary → Hex (шестнадцатеричная строка)
3. Hex → GUID (форматированная строка)

**Пример**:
```bsl
Функция Base64_2_GUID(Base64)
    Число2 = Число2_Из_Base64(Base64);        // Base64 → Binary
    Число16 = Число16_Из_Числа2(Число2);      // Binary → Hex
    Результат = GUID_Из_Числа16(Число16);     // Hex → GUID
    Возврат Результат;
КонецФункции
```

---

## Процессы работы

### 1. Процесс аутентификации

```
┌─────────────────┐
│ Пользователь    │
│ открывает форму │
└────────┬────────┘
         │
         ▼
┌────────────────────────────────────┐
│ Проверка параметров сеанса         │
│ ЛогинДиадок, ПарольДиадок          │
└────────┬───────────────────────────┘
         │
         ├─── Заполнены ──────────────────────┐
         │                                    │
         ├─── НЕ заполнены                   │
         │                                    ▼
         ▼                          ┌─────────────────────┐
┌─────────────────────┐             │ Продолжить операцию │
│ Открыть форму       │             └─────────────────────┘
│ ФормаЗапросаДанныхД │
│ иадока              │
└────────┬────────────┘
         │
         ▼
┌─────────────────────────────┐
│ Ввод логина и пароля        │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│ POST /Authenticate                      │
│ Проверка учетных данных через API       │
└────────┬────────────────────────────────┘
         │
         ├─── Успех ─────────────────────────┐
         │                                   │
         ├─── Ошибка                         │
         │                                   ▼
         ▼                         ┌────────────────────┐
┌─────────────────────┐            │ Сохранить в        │
│ Сообщить об ошибке  │            │ параметры сеанса   │
└─────────────────────┘            └──────────┬─────────┘
                                              │
                                              ▼
                                    ┌─────────────────────┐
                                    │ Продолжить операцию │
                                    └─────────────────────┘
```

### 2. Процесс получения статуса документа

```
┌─────────────────────────────┐
│ Пользователь нажимает       │
│ "Получить статус"           │
└──────────┬──────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Проверка аутентификации      │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ POST /Authenticate           │
│ Получение токена             │
└──────────┬───────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ Получение идентификаторов из БД:      │
│ - boxId (ящик)                        │
│ - messageId, entityId (документ)      │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ GET /V3/GetDocument                   │
│ ?boxId={boxId}&messageId={messageId}  │
│ &entityId={entityId}                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Парсинг JSON ответа:                   │
│ - RecipientReceiptMetadata.            │
│   ReceiptStatus                        │
│ - DocflowStatus.PrimaryStatus.         │
│   StatusText                           │
└──────────┬─────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Маппинг статусов через соответствие    │
│ (RevocationAccepted → "Аннулирован")   │
└──────────┬─────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Сохранение в РегистрСведений.          │
│ ДополнительныеСведения:                │
│ - ДатаПолученияСтатуса = ТекущаяДата()│
│ - СтатусДиадок = Статус               │
└──────────┬─────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Обновление реквизита формы             │
│ Форма.СтатусДиадок = Статус           │
└────────────────────────────────────────┘
```

### 3. Процесс перехода к документу в Диадок

```
┌─────────────────────────────┐
│ Пользователь нажимает       │
│ "Перейти в Диадок"          │
└──────────┬──────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Проверка аутентификации      │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Получение идентификаторов    │
│ документа из БД              │
└──────────┬───────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ Конвертация идентификаторов:            │
│ - boxId: адрес ящика → GUID             │
│ - messageId: Base64 → GUID (первые 36)  │
│ - entityId: Base64 → GUID (последние 36)│
└──────────┬──────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ Формирование URL:                       │
│ https://diadoc.kontur.ru/{boxId}/       │
│ document/show?letterId={messageId}&     │
│ documentId={entityId}                   │
└──────────┬──────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ ЗапуститьПриложение(URL)                │
│ Открытие браузера                       │
└─────────────────────────────────────────┘
```

### 4. Инициализация формы с интеграцией

```
┌─────────────────────────────┐
│ ПриСозданииНаСервере        │
└──────────┬──────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ MRS_ИнтеграцияДиадокКлиентСервер.        │
│ ДополнитьФормуИнтеграциейДиадок(ЭтотОбъект)│
└──────────┬───────────────────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Определение типа формы:      │
│ - ФормаДокумента             │
│ - СписокДокументов           │
│ - Универсальная              │
└──────────┬───────────────────┘
           │
           ├─── Форма документа ───────────────────┐
           │                                       │
           ├─── Форма списка ──────────────────┐   │
           │                                   │   │
           ▼                                   ▼   ▼
┌────────────────────┐          ┌──────────────────────────┐
│ Добавление:        │          │ Добавление:              │
│ - Реквизит         │          │ - Колонка СозданВДиадок  │
│   СтатусДиадок     │          │ - Колонка СтатусЭДО      │
│ - Группа           │          │ - Группа кнопок          │
│   ГруппаДиадок     │          │ - Расширение запроса     │
│ - Команды          │          │ - Команды                │
│ - Кнопки           │          │ - Кнопки                 │
│ - Поле статуса     │          └──────────────────────────┘
└────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│ Загрузка текущего статуса из БД     │
│ (для формы документа)               │
└─────────────────────────────────────┘
```

---

## Настройка и конфигурация

### Требования к настройке системы

#### 1. План видов характеристик "ДополнительныеРеквизитыИСведения"

Необходимо создать следующие характеристики с `ИдентификаторДляФормул`:

| Наименование | ИдентификаторДляФормул | Тип значения |
|-------------|------------------------|--------------|
| Дата получения статуса | `ДатаПолученияСтатуса` | Дата |
| Статус Диадок | `СтатусДиадок` | Строка(250) |
| Идентификатор документа в Диадок | `ИдентификаторДокументаВДиадок` | Строка(250) |
| Идентификатор ящика документа в Диадок | `ИдентификаторЯщикДокументаВДиадок` | Строка(250) |

#### 2. Параметры сеанса

Создать параметры сеанса:
- `ЛогинДиадок` (Строка, неограниченная)
- `ПарольДиадок` (Строка, неограниченная)
- `КлючРазработчикаДиадок` (Строка, неограниченная)

#### 3. Регистр сведений "ДополнительныеСведения"

**Измерения**:
- `Объект` (Определяемый тип)
- `Свойство` (ПланВидовХарактеристикСсылка.ДополнительныеРеквизитыИСведения)

**Ресурсы**:
- `Значение` (Определяемый тип)

#### 4. Общий макет "БиблиотекаТекстов"

Макет должен содержать XML структуру с набором данных `КонвертацияBase64` для преобразования Base64:
- `Convert_Base64_to_Binary` - Соответствие символов Base64 к двоичным строкам
- `Convert_Binary_to_Hex` - Соответствие двоичных строк к шестнадцатеричным

#### 5. Общая картинка "ITS_ДиадокОбщаяКартинка"

Картинка для кнопок интеграции с Диадок (логотип или иконка).

### Конфигурирование API ключа

API ключ по умолчанию:
```bsl
Функция ПолучитьКлючРазработчикаПоУмолчанию()
    Возврат "1C";
КонецФункции
```

Для использования собственного ключа:
1. Зарегистрироваться в личном кабинете разработчика Диадок
2. Получить API ключ
3. Изменить значение в функции `ПолучитьКлючРазработчикаПоУмолчанию()`

### Права доступа

Модули используют привилегированный режим для работы с параметрами сеанса:

```bsl
Функция ПолучитьЛогинДиадок() Экспорт
    УстановитьПривилегированныйРежим(Истина);
    Попытка
        Результат = ПараметрыСеанса.ЛогинДиадок;
    Исключение
        Результат = "";
    КонецПопытки;
    УстановитьПривилегированныйРежим(Ложь);
    Возврат Результат;
КонецФункции
```

---

## Обработка ошибок

### Стратегия обработки ошибок

#### 1. Ошибки аутентификации

**Сценарий**: Неверные логин/пароль

**Обработка**:
```bsl
Если Найти(ТекстОтвета, "Wrong") > 0 Тогда
    Результат.ТекстОшибки = "Неверный логин или пароль";
    Возврат Результат;
КонецЕсли;
```

**Возвращаемая структура**:
```bsl
Результат = Новый Структура;
Результат.Вставить("Успех", Ложь);
Результат.Вставить("ТекстОшибки", "Неверный логин или пароль");
```

#### 2. Ошибки сетевого взаимодействия

**Сценарий**: Проблемы с подключением к API

**Обработка**:
```bsl
Попытка
    Соединение.ОтправитьДляОбработки(HTTPЗапрос, ФайлРезультата);
Исключение
    УдалитьФайлы(ФайлРезультата);
    Результат.ТекстОшибки = "Ошибка подключения к Диадок: " + ОписаниеОшибки();
    Возврат Результат;
КонецПопытки;
```

#### 3. Ошибки парсинга данных

**Сценарий**: Некорректный формат ответа API

**Обработка**:
```bsl
Попытка
    Статус_ = Статусы.Получить(СтруктураJson1.RecipientReceiptMetadata.ReceiptStatus);
Исключение
    Статус_ = "";
КонецПопытки;

Если Статус_ = Неопределено Тогда
    Статус_ = "";
КонецЕсли;
```

#### 4. Ошибки отсутствия данных

**Сценарий**: Документ не найден в Диадок

**Обработка**:
```bsl
Если НЕ ЗначениеЗаполнено(Документ) Тогда
    Возврат "";
КонецЕсли;
```

**Сценарий**: Отсутствуют идентификаторы в БД

```bsl
Если РезультатЗапроса.Пустой() Тогда
    Возврат "";
КонецЕсли;
```

#### 5. Ошибки конвертации идентификаторов

**Сценарий**: Некорректный формат адреса ящика

**Обработка**:
```bsl
Функция АдресЯщикаВИдентификатор(АдресЯщика) Экспорт
    ДлинаИД = СтрДлина(ИД);
    
    Если ДлинаИД = 32 Тогда
        // Обработка
    ИначеЕсли ДлинаИД = 36 Тогда
        // Обработка
    Иначе
        ТекстОшибки = ПодставитьПараметрыВСтроку(
            НСтр("ru = 'Некорректный адрес ящика %1'"), АдресЯщика);
        ВызватьИсключение ТекстОшибки;
    КонецЕсли;
КонецФункции
```

### Логирование

Система не предусматривает встроенное логирование ошибок. Для добавления логирования рекомендуется:

### Очистка временных файлов

Все временные файлы удаляются после использования:

```bsl
ФайлРезультата = ПолучитьИмяВременногоФайла();
Попытка
    Соединение.ОтправитьДляОбработки(HTTPЗапрос, ФайлРезультата);
    // Обработка
Исключение
    УдалитьФайлы(ФайлРезультата);
    ВызватьИсключение;
КонецПопытки;
УдалитьФайлы(ФайлРезультата);
```

---

## Приложения

### Приложение А: Примеры использования

#### Пример 1: Добавление интеграции в новую форму документа

```bsl
#Область ОбработчикиСобытийФормы

&После("ПриСозданииНаСервере")
Процедура MRS_ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    MRS_ИнтеграцияДиадокКлиентСервер.ДополнитьФормуИнтеграциейДиадок(ЭтотОбъект);
КонецПроцедуры

#КонецОбласти

#Область ИнтеграцияДиадок

&НаКлиенте
Процедура ДиадокПерейтиВЛичныйКабинет(Команда)
    Ссылка = Объект.Ссылка;
    MRS_ИнтеграцияДиадокКлиент.ПерейтиКДокументуДиадок(ЭтотОбъект, Ссылка);
КонецПроцедуры

&НаКлиенте
Процедура ДиадокПолучитьСтатус(Команда)
    Ссылка = Объект.Ссылка;
    MRS_ИнтеграцияДиадокКлиент.ПолучитьСтатусДокументаДиадок(ЭтотОбъект, Ссылка);
КонецПроцедуры

#КонецОбласти
```

#### Пример 2: Программное получение статуса

```bsl
Процедура ПолучитьСтатусыДокументовЗаПериод(НачалоПериода, КонецПериода)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ПриобретениеТоваровУслуг.Ссылка КАК Ссылка
    |ИЗ
    |    Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
    |ГДЕ
    |    ПриобретениеТоваровУслуг.Дата МЕЖДУ &НачалоПериода И &КонецПериода
    |    И ПриобретениеТоваровУслуг.Проведен";
    
    Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
    Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
    
    Выборка = Запрос.Выполнить().Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        Статус = MRS_ИнтеграцияДиадокСервер.ПолучитьСтруктуруДокументаПоAPIДиадок(
            ЛогинДиадок, ПарольДиадок, КлючРазработчика, Выборка.Ссылка);
        
        Если ЗначениеЗаполнено(Статус) Тогда
            MRS_ИнтеграцияДиадокСервер.СохранитьСтатусДокумента(Статус, Выборка.Ссылка);
        КонецЕсли;
        
    КонецЦикла;
    
КонецПроцедуры
```

#### Пример 3: Получение URL документа

```bsl
Функция ПолучитьСсылкуНаДокумент(Документ)
    
    ЛогинДиадок = MRS_ИнтеграцияДиадокСервер.ПолучитьЛогинДиадок();
    ПарольДиадок = MRS_ИнтеграцияДиадокСервер.ПолучитьПарольДиадок();
    КлючРазработчика = MRS_ИнтеграцияДиадокСервер.ПолучитьКлючРазработчикаДиадок();
    
    URL = MRS_ИнтеграцияДиадокСервер.ПолучитьСсылкуНаДокументДиадок(
        ЛогинДиадок, ПарольДиадок, КлючРазработчика, Документ);
    
    Возврат URL;
    
КонецФункции
```

### Приложение Б: FAQ

**Q: Как часто обновляются статусы документов?**
A: Статусы обновляются только при явном запросе пользователя через кнопку "Получить статус". Для автоматического обновления необходимо реализовать регламентное задание.

**Q: Можно ли использовать несколько учетных записей Диадок?**
A: Текущая реализация поддерживает только одну учетную запись в рамках сеанса пользователя. Параметры сеанса хранят данные одной учетной записи.

**Q: Как обрабатываются документы без идентификаторов Диадок?**
A: Если у документа отсутствуют идентификаторы в регистре `ДополнительныеСведения`, методы возвращают пустую строку без генерации ошибки.

**Q: Поддерживается ли отправка документов в Диадок?**
A: Нет, текущая реализация поддерживает только чтение статусов и переход к документам. Отправка должна быть реализована отдельно.

**Q: Как работает кэширование токенов?**
A: Токены не кэшируются. При каждом запросе к API выполняется новая аутентификация через `/Authenticate`.

---

## Версионирование и изменения

**Текущая версия**: 1.0

**История изменений**:

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2025-10-23 | Первая версия документации |

---

## Контакты и поддержка

**Разработчик**: MRIYA ERP Extensions - Alexwy Shvetsov
**Email**: support@example.com

**Полезные ссылки**:
- [Документация API Диадок](https://developer.kontur.ru/doc/diadoc-api/)
- [OpenAPI спецификация Диадок](https://www.diadoc.ru/articles/81279)
- [Личный кабинет Диадок](https://diadoc.kontur.ru/)

---

