# Техническая документация: Интеграция с Диадок

## Оглавление

1. [Общие сведения](#общие-сведения)
2. [Архитектура решения](#архитектура-решения)
3. [Компоненты системы](#компоненты-системы)
4. [API и методы](#api-и-методы)
5. [Структуры данных](#структуры-данных)
6. [Процессы работы](#процессы-работы)
7. [Настройка и конфигурация](#настройка-и-конфигурация)
8. [Обработка ошибок](#обработка-ошибок)

---

## Общие сведения

### Назначение

Модуль интеграции с сервисом электронного документооборота **Диадок** для платформы 1С:Предприятие 8.3. Решение обеспечивает:

- **Мультиорганизационную** работу с API Диадок (индивидуальные API-ключи для каждой организации)
- Массовое получение статусов документов разных организаций
- Получение статусов документов из Диадок
- Переход к документам в веб-интерфейсе Диадок
- Отображение статусов ЭДО в интерфейсе системы
- Аутентификацию и авторизацию пользователей

### Ключевые особенности

- ✅ **Индивидуальные API-ключи**: Каждая организация использует свой ключ разработчика
- ✅ **Массовая обработка**: Поддержка обработки документов нескольких организаций одновременно
- ✅ **Детальная отчетность**: Структурированные отчеты о результатах обработки с указанием проблемных организаций
- ✅ **Использование БСП**: Применение методов Библиотеки стандартных подсистем для работы с коллекциями
- ✅ **Обратная совместимость**: Сохранена поддержка работы с одним документом
- ✅ **Улучшенный UX**: Форма авторизации открывается модально (небольшое окно по центру)
- ✅ **Умная проверка авторизации**: Автоматический подбор API-ключа из базы для проверки учетных данных
- ✅ **Fallback-механизм**: Использование стандартного ключа "1C" если индивидуальные не настроены

### Технический стек

- **Платформа**: 1С:Предприятие 8.3
- **API Диадок**: HTTP REST API
- **Протокол**: HTTPS
- **Формат данных**: JSON
- **Аутентификация**: DiadocAuth (логин/пароль + API ключ)

### Базовые URL

- **API**: `https://diadoc-api.kontur.ru`
- **Web-интерфейс**: `https://diadoc.kontur.ru`

---

## Архитектура решения

### Трехуровневая архитектура

Решение построено по трехуровневой архитектуре:

```
┌─────────────────────────────────────────┐
│         Клиентский уровень              │
│   (MRS_ИнтеграцияДиадокКлиент)         │
│   - Обработка действий пользователя     │
│   - Управление UI                       │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Клиент-Серверный уровень           │
│  (MRS_ИнтеграцияДиадокКлиентСервер)    │
│   - Утилиты конвертации                 │
│   - Формирование UI элементов           │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         Серверный уровень               │
│    (MRS_ИнтеграцияДиадокСервер)        │
│   - HTTP запросы к API                  │
│   - Работа с базой данных               │
│   - Бизнес-логика                       │
└─────────────────────────────────────────┘
```

### Компоненты по уровням

#### Клиентский уровень
- Формы документов (ПриобретениеТоваровУслуг)
- Формы списков (ЖурналДокументовЗакупки)
- Форма аутентификации (ФормаЗапросаДанныхДиадока)

#### Серверный уровень
- Параметры сеанса (ЛогинДиадок, ПарольДиадок)
- Регистр сведений (ДополнительныеСведения)
- План видов характеристик (ДополнительныеРеквизитыИСведения)

### Мультиорганизационная архитектура

#### Хранение API-ключей

```
┌────────────────────────────────────────────────┐
│  РегистрСведений.ДополнительныеСведения        │
├────────────────────────────────────────────────┤
│  Объект: Справочник.Организации                │
│  Свойство: MRS_КлючРазработчикаДиадок         │
│  Значение: "ключ_api_организации_1"           │
├────────────────────────────────────────────────┤
│  Объект: Справочник.Организации                │
│  Свойство: MRS_КлючРазработчикаДиадок         │
│  Значение: "ключ_api_организации_2"           │
└────────────────────────────────────────────────┘
```

#### Поток обработки массива документов

```
1. Группировка документов по организациям
   ПолучитьОрганизацииДокументов(МассивДокументов)
   → Соответствие: Организация → Массив(Документы)

2. Получение API-ключа для каждой организации
   Для каждой организации:
     ПолучитьКлючРазработчикаОрганизацииДокумента(Организация)
   
3. Массовая обработка документов
   ПолучитьСтатусыДокументовМассово(МассивДокументов, Логин, Пароль)
   → Структура результатов с детализацией по организациям

4. Формирование отчета
   СформироватьОтчетРезультатовОбработки(РезультатОбработки)
   → Текстовый отчет для пользователя
```

#### Преимущества архитектуры

| Характеристика | Описание |
|----------------|----------|
| API-ключ | Индивидуальный для каждой организации |
| Массовая обработка | С группировкой по организациям |
| Отчетность | Детализированная с указанием проблем |
| Обработка ошибок | Расширенная с категоризацией |
| Параметры сеанса | Только логин/пароль пользователя |

---

## Компоненты системы

### 1. Общие модули

#### MRS_ИнтеграцияДиадокКлиент

**Назначение**: Клиентская логика интеграции

**Основные функции**:
- `ПерейтиКДокументуДиадок(Форма, Документ)` - Переход к документу в веб-интерфейсе
- `ПолучитьСтатусДокументаДиадок(Форма, Документ)` - Получение статуса документа (поддерживает массив)
- `ПроверитьДанныеАвторизации(Логин, Пароль)` - Проверка учетных данных

**Серверные вызовы**:
- `ПолучитьСтатусыМассовоНаСервере(МассивДокументов, ЛогинДиадок, ПарольДиадок)` - Массовое получение статусов

**Особенности**:
- Управление оповещениями после ввода учетных данных
- Поддержка массового получения статусов с детальной отчетностью
- Автоматическое обновление формы списка после обработки
- Кэширование параметров сеанса (логин/пароль)

#### MRS_ИнтеграцияДиадокКлиентСервер

**Назначение**: Общие утилиты и функции конвертации

**Основные функции**:
- `ДополнитьФормуИнтеграциейДиадок(Форма, ИмяТаблицыДокументов)` - Динамическое добавление элементов UI
- `АдресЯщикаВИдентификатор(АдресЯщика)` - Преобразование адреса в GUID
- `СформироватьСсылкуВБраузере(BoxId, LetterId, DocumentId)` - Формирование URL
- `Base64_2_GUID(Base64)` - Конвертация Base64 в GUID

**Функции отчетности**:
- `СформироватьОтчетРезультатовОбработки(СтруктураРезультатов)` - Формирование текстового отчета о результатах массовой обработки

**Вспомогательные функции**:
- `ПодставитьПараметрыВСтроку()` - Шаблонизация строк
- `Convert_Base64_to_Binary()` - Base64 → Binary
- `Convert_Binary_to_Hex()` - Binary → Hex
- `Convert_Hex_to_GUID()` - Hex → GUID

#### MRS_ИнтеграцияДиадокСервер

**Назначение**: Серверная логика и работа с API

**Основные функции**:
- `ПроверитьДанныеАвторизации(Логин, Пароль)` - Аутентификация через API
- `ПолучитьСтруктуруДокументаПоAPIДиадок()` - Получение данных документа
- `ПолучитьСсылкуНаДокументДиадок()` - Формирование ссылки
- `СохранитьСтатусДокумента(Статус, Документ)` - Сохранение в БД
- `ПолучитьСтатусДокумента(Документ)` - Чтение из БД

**Мультиорганизационные функции**:
- `ПолучитьОрганизацииДокументов(МассивДокументов)` - Группировка документов по организациям
- `ПолучитьСтатусыДокументовМассово(МассивДокументов, ЛогинДиадок, ПарольДиадок)` - Массовое получение статусов с учетом организаций
- `ПолучитьКлючДляПроверкиАвторизации()` - Получение API-ключа для проверки учетных данных

**Работа с параметрами сеанса**:
- `ПолучитьЛогинДиадок()`
- `ПолучитьПарольДиадок()`
- `ПолучитьКлючРазработчикаДиадок(ОрганизацияДокумента)` - Получение ключа конкретной организации
- `УстановитьПараметрСеанса(ИмяПараметра, Значение)`

**Внутренние служебные функции**:
- `ПолучитьКлючРазработчикаОрганизацииДокумента(ОрганизацияДокумента)` - Получение API-ключа конкретной организации из регистра
- `ПолучитьКлючДляПроверкиАвторизации()` - Получение первого доступного API-ключа или "1C" по умолчанию

### 2. Формы

#### ФормаЗапросаДанныхДиадока

**Путь**: `CommonForms/ФормаЗапросаДанныхДиадока`

**Назначение**: Модальная форма для ввода учетных данных Диадок

**Реквизиты формы**:
- `ЛогинНаСайтДиадок` (Строка)
- `ПарольНаСайтДиадок` (Строка)

**Команды**:
- `Ок` - Проверка данных и возврат результата

**Возвращаемое значение** (Структура):
```bsl
СтруктураВозврата = Новый Структура;
СтруктураВозврата.Вставить("Логин", ЛогинНаСайтДиадок);
СтруктураВозврата.Вставить("Пароль", ПарольНаСайтДиадок);
// API-ключи хранятся индивидуально для каждой организации в РегистрСведений.ДополнительныеСведения
```

**Особенности**:
- Форма запрашивает только логин и пароль пользователя
- API-ключи получаются индивидуально для каждой организации при обработке документов
- Форма открывается как **модальное окно** поверх родительской формы (не на весь экран)
- Для проверки авторизации используется первый доступный API-ключ из базы или "1C" по умолчанию

**Параметры открытия формы**:
```bsl
ОткрытьФорму("ОбщаяФорма.ФормаЗапросаДанныхДиадока", , Форма, , , , 
    Новый ОписаниеОповещения(...), 
    РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
```
- Третий параметр `Форма` - владелец модального окна
- `РежимОткрытияОкнаФормы.БлокироватьОкноВладельца` - блокирует работу с родительской формой

#### Форма документа ПриобретениеТоваровУслуг

**Расширение**: `Documents/ПриобретениеТоваровУслуг/Forms/ФормаДокумента`

**Добавленные элементы**:
- Реквизит `СтатусДиадок` (Строка, 250)
- Группа `ГруппаДиадок` (после поля Комментарий)
- Кнопка `КнопкаДиадокПерейти` - Переход в Диадок
- Кнопка `КнопкаДиадокПолучитьСтатус` - Обновление статуса
- Поле `ПолеСтатусДиадок` - Отображение статуса

**Обработчики**:
- `MRS_ПриСозданииНаСервере()` - Инициализация интеграции
- `ДиадокПерейтиВЛичныйКабинет()` - Переход к документу
- `ДиадокПолучитьСтатус()` - Получение статуса

#### Форма списка ЖурналДокументовЗакупки

**Расширение**: `DataProcessors/ЖурналДокументовЗакупки/Forms/СписокДокументов`

**Добавленные элементы**:
- Колонка `СозданВДиадок` (Булево, флажок)
- Колонка `СтатусЭДО` (Строка, отображение в списке)
- Группа кнопок `ГруппаДиадок` (после ГруппаОрганайзер)

**Модифицированный запрос**:
```sql
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК ДатаПолучСтатуса
  ПО РеестрДокументов.Ссылка = ДатаПолучСтатуса.Объект
    И (ДатаПолучСтатуса.Свойство.ИдентификаторДляФормул = "ДатаПолученияСтатуса")
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК Статус_Диадок
  ПО РеестрДокументов.Ссылка = Статус_Диадок.Объект
    И (Статус_Диадок.Свойство.ИдентификаторДляФормул = "СтатусДиадок")
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК ДополнительныеСведения
  ПО РеестрДокументов.Ссылка = ДополнительныеСведения.Объект
    И (ДополнительныеСведения.Свойство.ИдентификаторДляФормул = "ИдентификаторЯщикДокументаВДиадок")
```

### 3. Регистры и справочники

#### РегистрСведений.ДополнительныеСведения

**Назначение**: Хранение метаданных документов Диадок и API-ключей организаций

**Ключевые записи для документов** (по `ИдентификаторДляФормул`):
- `ДатаПолученияСтатуса` - Дата последнего обновления статуса
- `СтатусДиадок` - Текущий статус документа в Диадок
- `ИдентификаторДокументаВДиадок` - Base64 идентификатор документа
- `ИдентификаторЯщикДокументаВДиадок` - Идентификатор ящика

**Ключевые записи для организаций** (по `ИдентификаторДляФормул`):
- `MRS_КлючРазработчикаДиадок` - API-ключ разработчика конкретной организации

**Пример записи API-ключа для организации**:
```bsl
Объект = Справочники.Организации.НайтиПоНаименованию("ООО Мрия");
Свойство = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("MRS_КлючРазработчикаДиадок");
Значение = "api_key_организации_мрия";

НаборЗаписей = РегистрыСведений.ДополнительныеСведения.СоздатьНаборЗаписей();
НаборЗаписей.Отбор.Объект.Установить(Объект);
НаборЗаписей.Отбор.Свойство.Установить(Свойство);
Запись = НаборЗаписей.Добавить();
Запись.Объект = Объект;
Запись.Свойство = Свойство;
Запись.Значение = Значение;
НаборЗаписей.Записать();
```

#### Параметры сеанса

- `ЛогинДиадок` (Строка) - Логин пользователя
- `ПарольДиадок` (Строка) - Пароль пользователя

**Примечание**: API-ключи хранятся индивидуально для каждой организации в `РегистрСведений.ДополнительныеСведения`. Параметры сеанса хранят только учетные данные пользователя (логин/пароль).

---

## API и методы

### Аутентификация

#### POST /Authenticate

**Назначение**: Получение токена для доступа к API

**Параметры запроса**:
- `login` - Логин пользователя
- `password` - Пароль пользователя

**Заголовки**:
```http
POST /Authenticate?login={login}&password={password} HTTP/1.1
Host: diadoc-api.kontur.ru
Content-Length: 0
Authorization: DiadocAuth ddauth_api_client_id={api_key}
```

**Ответ**: Токен в теле ответа (строка)

**Пример кода**:
```bsl
// Получение API-ключа для проверки авторизации
КлючРазработчика = ПолучитьКлючДляПроверкиАвторизации();
// Возвращает первый доступный ключ из организаций или "1C" по умолчанию

АдресРесурса = "/Authenticate?login=" + ЛогинНаСайтДиадок + "&password=" + ПарольНаСайтДиадок;
АдресСайта = "diadoc-api.kontur.ru";

HTTPЗапрос = Новый HTTPЗапрос;
HTTPЗапрос.Заголовки.Вставить("POST " + АдресРесурса + " HTTP/1.1");
HTTPЗапрос.Заголовки.Вставить("Host", АдресСайта);
HTTPЗапрос.Заголовки.Вставить("Content-Length", 0);
HTTPЗапрос.Заголовки.Вставить("Authorization", "DiadocAuth ddauth_api_client_id=" + КлючРазработчика);
HTTPЗапрос.АдресРесурса = АдресРесурса;

Соединение = Новый HTTPСоединение(АдресСайта, , , , , 60, Новый ЗащищенноеСоединениеOpenSSL(), Ложь);
```

#### ПолучитьКлючДляПроверкиАвторизации()

**Назначение**: Получение API-ключа для проверки учетных данных пользователя

**Логика работы**:
1. Выполняется запрос к `РегистрСведений.ДополнительныеСведения` для поиска первого доступного ключа с `ИдентификаторДляФормул = "MRS_КлючРазработчикаДиадок"`
2. Если ключ найден - возвращается значение из базы
3. Если ключи не настроены - возвращается "1C" (стандартный ключ для интеграций 1С от СКБ Контур)

**Возвращаемое значение**: Строка - API-ключ

**Пример использования**:
```bsl
Функция ПроверитьДанныеАвторизации(ЛогинНаСайтДиадок, ПарольНаСайтДиадок) Экспорт
    
    // Получаем ключ для проверки
    КлючРазработчика = ПолучитьКлючДляПроверкиАвторизации();
    
    // Выполняем аутентификацию через API
    АдресРесурса = "/Authenticate?login=" + ЛогинНаСайтДиадок + "&password=" + ПарольНаСайтДиадок;
    // ...
    
КонецФункции
```

**Примечание**: Ключ "1C" является общедоступным ключом для базовых интеграций. Для production-использования рекомендуется получить индивидуальный ключ в личном кабинете разработчика Диадок.

### Получение документа

#### GET /V3/GetDocument

**Назначение**: Получение полной информации о документе

**Параметры запроса**:
- `boxId` - Идентификатор ящика (GUID)
- `messageId` - Идентификатор сообщения (GUID)
- `entityId` - Идентификатор сущности (GUID)

**Заголовки**:
```http
GET /V3/GetDocument HTTP/1.1
Host: diadoc-api.kontur.ru
Accept: application/json
Content-Type: application/json; charset=utf-8
Authorization: DiadocAuth ddauth_api_client_id={api_key},ddauth_token={token}
```

**Структура ответа** (JSON):
```json
{
  "RecipientReceiptMetadata": {
    "ReceiptStatus": "Finished"
  },
  "DocflowStatus": {
    "PrimaryStatus": {
      "StatusText": "Документооборот завершен"
    }
  }
}
```

**Пример кода**:
```bsl
boxId = ПолучитьИдентификаторЯщикаДокумента(Документ);
Гуид = ПолучитьИдентификаторДокумента(Документ);
messageId = Лев(Гуид, 36);
entityId = СтрЗаменить(Гуид, messageId, "");

АдресСайта = "diadoc-api.kontur.ru/V3/GetDocument?boxId=" + boxId + "&messageId=" + messageId + "&entityId=" + entityId;

HTTPЗапрос = Новый HTTPЗапрос;
HTTPЗапрос.Заголовки.Вставить("Accept", "application/json");
HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
HTTPЗапрос.Заголовки.Вставить("Authorization", "DiadocAuth ddauth_api_client_id=" + КлючРазработчика + ",ddauth_token=" + Токен);
```

---

## Структуры данных

### Структура результатов обработки

#### СтруктураРезультатовОбработки

Возвращается функцией `ПолучитьСтатусыДокументовМассово()`:

```bsl
СтруктураРезультатов = Новый Структура;
СтруктураРезультатов.Вставить("ВсегоДокументов", 15);                    // Число
СтруктураРезультатов.Вставить("УспешноОбработано", 10);                  // Число
СтруктураРезультатов.Вставить("СОшибками", 5);                          // Число
СтруктураРезультатов.Вставить("ОрганизацииБезКлюча", Массив);           // Массив из Структура
СтруктураРезультатов.Вставить("ОшибкиПоДокументам", Соответствие);      // Документ → ТекстОшибки
СтруктураРезультатов.Вставить("ДокументыБезИдентификаторов", Массив);   // Массив из ДокументСсылка
```

**Структура элемента "ОрганизацииБезКлюча"**:
```bsl
ЭлементОшибки = Новый Структура;
ЭлементОшибки.Вставить("Организация", СправочникСсылка.Организации);
ЭлементОшибки.Вставить("Наименование", "ООО Тест");
ЭлементОшибки.Вставить("КоличествоДокументов", 5);
```

**Пример использования**:
```bsl
РезультатОбработки = MRS_ИнтеграцияДиадокСервер.ПолучитьСтатусыДокументовМассово(
    МассивДокументов, ЛогинДиадок, ПарольДиадок);

// Формирование отчета
ТекстОтчета = MRS_ИнтеграцияДиадокКлиентСервер.СформироватьОтчетРезультатовОбработки(РезультатОбработки);

// Отображение пользователю
ПоказатьПредупреждение(, ТекстОтчета, , "Результаты получения статусов");
```

### Статусы документов

#### Соответствие статусов API

| Код статуса | Текстовое представление |
|-------------|------------------------|
| `RevocationAccepted` | Аннулирован |
| `Finished` | Документооборот завершен |
| `RevocationIsRequestedByMe` | Ожидается аннулирование |
| `InvalidSenderSignature` | Ошибка подписи |
| `RoamingNotificationError` | Ошибка доставки документа через роуминг |
| `WithRecipientSignature` | Подписан контрагентом |
| `RequestsMyRevocation` | Требуется аннулирование |
| `HaveToCreateReceipt` | Требуется подписать извещение |
| `InvoiceAmendmentRequested` | Требуется уточнение |
| `RecipientSignatureRequestRejected` | Отказано в подписи контрагенту |
| `WaitingForRecipientSignature` | Требуется подпись |
| `WaitingForReceipt` | Ожидается извещение о получении |
| `WaitingForProxySignature` | Ожидается промежуточная подпись |
| `ProxySignatureRejected` | Отказано в промежуточной подписи |

### Идентификаторы

#### Формат GUID документа

Идентификатор документа хранится в формате:
```
{messageId}-{entityId}
```

Где:
- `messageId` - GUID сообщения (36 символов)
- `entityId` - GUID сущности (36 символов)

Общая длина: 72 символа (с разделителем)

#### Формат адреса ящика

Возможные форматы:
1. Email-подобный: `{guid}@diadoc.ru`
2. GUID без дефисов: `00000000000000000000000000000000` (32 символа)
3. GUID с дефисами: `00000000-0000-0000-0000-000000000000` (36 символов)

Функция конвертации:
```bsl
Функция АдресЯщикаВИдентификатор(АдресЯщика)
    АдресЯщикаБезПробелов = СокрЛП(АдресЯщика);
    ИД = СтрЗаменить(АдресЯщикаБезПробелов, "@diadoc.ru", "");
    ДлинаИД = СтрДлина(ИД);
    
    Если ДлинаИД = 32 Тогда
        // Преобразование в формат с дефисами
        Результат = Сред(ИД, 1, 8) + "-" + Сред(ИД, 9, 4) + "-" + 
                    Сред(ИД, 13, 4) + "-" + Сред(ИД, 17, 4) + "-" + 
                    Сред(ИД, 21, 12);
    ИначеЕсли ДлинаИД = 36 Тогда
        Результат = ИД;
    Иначе
        ВызватьИсключение "Некорректный адрес ящика";
    КонецЕсли;
    
    Возврат Результат;
КонецФункции
```

### Конвертация Base64 → GUID

Идентификаторы в регистре `ДополнительныеСведения` хранятся в формате Base64 и требуют конвертации:

**Этапы конвертации**:
1. Base64 → Binary (строка из 0 и 1)
2. Binary → Hex (шестнадцатеричная строка)
3. Hex → GUID (форматированная строка)

**Пример**:
```bsl
Функция Base64_2_GUID(Base64)
    Число2 = Число2_Из_Base64(Base64);        // Base64 → Binary
    Число16 = Число16_Из_Числа2(Число2);      // Binary → Hex
    Результат = GUID_Из_Числа16(Число16);     // Hex → GUID
    Возврат Результат;
КонецФункции
```

---

## Процессы работы

### 1. Процесс аутентификации

```
┌─────────────────┐
│ Пользователь    │
│ открывает форму │
└────────┬────────┘
         │
         ▼
┌────────────────────────────────────┐
│ Проверка параметров сеанса         │
│ ЛогинДиадок, ПарольДиадок          │
└────────┬───────────────────────────┘
         │
         ├─── Заполнены ──────────────────────┐
         │                                    │
         ├─── НЕ заполнены                   │
         │                                    ▼
         ▼                          ┌─────────────────────┐
┌─────────────────────┐             │ Продолжить операцию │
│ Открыть форму       │             └─────────────────────┘
│ ФормаЗапросаДанныхД │
│ иадока              │
└────────┬────────────┘
         │
         ▼
┌─────────────────────────────┐
│ Ввод логина и пароля        │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│ POST /Authenticate                      │
│ Проверка учетных данных через API       │
└────────┬────────────────────────────────┘
         │
         ├─── Успех ─────────────────────────┐
         │                                   │
         ├─── Ошибка                         │
         │                                   ▼
         ▼                         ┌────────────────────┐
┌─────────────────────┐            │ Сохранить в        │
│ Сообщить об ошибке  │            │ параметры сеанса   │
└─────────────────────┘            └──────────┬─────────┘
                                              │
                                              ▼
                                    ┌─────────────────────┐
                                    │ Продолжить операцию │
                                    └─────────────────────┘
```

### 2. Процесс получения статуса документа

```
┌─────────────────────────────┐
│ Пользователь нажимает       │
│ "Получить статус"           │
└──────────┬──────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Проверка аутентификации      │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ POST /Authenticate           │
│ Получение токена             │
└──────────┬───────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ Получение идентификаторов из БД:      │
│ - boxId (ящик)                        │
│ - messageId, entityId (документ)      │
└──────────┬────────────────────────────┘
           │
           ▼
┌───────────────────────────────────────┐
│ GET /V3/GetDocument                   │
│ ?boxId={boxId}&messageId={messageId}  │
│ &entityId={entityId}                  │
└──────────┬────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Парсинг JSON ответа:                   │
│ - RecipientReceiptMetadata.            │
│   ReceiptStatus                        │
│ - DocflowStatus.PrimaryStatus.         │
│   StatusText                           │
└──────────┬─────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Маппинг статусов через соответствие    │
│ (RevocationAccepted → "Аннулирован")   │
└──────────┬─────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Сохранение в РегистрСведений.          │
│ ДополнительныеСведения:                │
│ - ДатаПолученияСтатуса = ТекущаяДата()│
│ - СтатусДиадок = Статус               │
└──────────┬─────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────┐
│ Обновление реквизита формы             │
│ Форма.СтатусДиадок = Статус           │
└────────────────────────────────────────┘
```

### 3. Процесс перехода к документу в Диадок

```
┌─────────────────────────────┐
│ Пользователь нажимает       │
│ "Перейти в Диадок"          │
└──────────┬──────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Проверка аутентификации      │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Получение идентификаторов    │
│ документа из БД              │
└──────────┬───────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ Конвертация идентификаторов:            │
│ - boxId: адрес ящика → GUID             │
│ - messageId: Base64 → GUID (первые 36)  │
│ - entityId: Base64 → GUID (последние 36)│
└──────────┬──────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ Формирование URL:                       │
│ https://diadoc.kontur.ru/{boxId}/       │
│ document/show?letterId={messageId}&     │
│ documentId={entityId}                   │
└──────────┬──────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ ЗапуститьПриложение(URL)                │
│ Открытие браузера                       │
└─────────────────────────────────────────┘
```

### 4. Инициализация формы с интеграцией

```
┌─────────────────────────────┐
│ ПриСозданииНаСервере        │
└──────────┬──────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ MRS_ИнтеграцияДиадокКлиентСервер.        │
│ ДополнитьФормуИнтеграциейДиадок(ЭтотОбъект)│
└──────────┬───────────────────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Определение типа формы:      │
│ - ФормаДокумента             │
│ - СписокДокументов           │
│ - Универсальная              │
└──────────┬───────────────────┘
           │
           ├─── Форма документа ───────────────────┐
           │                                       │
           ├─── Форма списка ──────────────────┐   │
           │                                   │   │
           ▼                                   ▼   ▼
┌────────────────────┐          ┌──────────────────────────┐
│ Добавление:        │          │ Добавление:              │
│ - Реквизит         │          │ - Колонка СозданВДиадок  │
│   СтатусДиадок     │          │ - Колонка СтатусЭДО      │
│ - Группа           │          │ - Группа кнопок          │
│   ГруппаДиадок     │          │ - Расширение запроса     │
│ - Команды          │          │ - Команды                │
│ - Кнопки           │          │ - Кнопки                 │
│ - Поле статуса     │          └──────────────────────────┘
└────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│ Загрузка текущего статуса из БД     │
│ (для формы документа)               │
└─────────────────────────────────────┘
```

### 5. Массовое получение статусов с мультиорганизационностью

```
┌────────────────────────────────────────┐
│ Пользователь выбирает документы        │
│ в списке и нажимает "Получить статус"  │
└────────────┬───────────────────────────┘
             │
             ▼
┌────────────────────────────────────────┐
│ Формирование массива документов        │
│ МассивДокументов = [Док1, Док2, ...]   │
└────────────┬───────────────────────────┘
             │
             ▼
┌────────────────────────────────────────┐
│ Проверка аутентификации                │
│ (логин/пароль в параметрах сеанса)     │
└────────────┬───────────────────────────┘
             │
             ├─── НЕ авторизован ────────────┐
             │                               │
             ├─── Авторизован                │
             │                               ▼
             ▼                    ┌────────────────────┐
┌──────────────────────────┐     │ Открыть форму      │
│ Серверный вызов:         │     │ авторизации        │
│ ПолучитьСтатусыМассово() │     └────────────────────┘
└────────────┬─────────────┘
             │
             ▼
┌────────────────────────────────────────────┐
│ ПолучитьОрганизацииДокументов()            │
│ Группировка по организациям:               │
│ {                                          │
│   ООО Мрия → [Док1, Док2],                │
│   ООО Бизнес → [Док3]                     │
│ }                                          │
└────────────┬───────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────┐
│ Для каждой организации:                    │
│                                            │
│ 1. Получить API-ключ из РегистрСведений    │
│    ПолучитьКлючРазработчика(Организация)   │
│                                            │
│ 2. Если ключ НЕ найден:                    │
│    - Добавить в ОрганизацииБезКлюча        │
│    - Пропустить документы организации      │
│                                            │
│ 3. Если ключ найден:                       │
│    - Аутентификация /Authenticate          │
│    - Для каждого документа:                │
│      * Получить идентификаторы             │
│      * GET /V3/GetDocument                 │
│      * Сохранить статус в БД               │
└────────────┬───────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────┐
│ Формирование структуры результатов:        │
│ {                                          │
│   ВсегоДокументов: 10,                     │
│   УспешноОбработано: 7,                    │
│   СОшибками: 3,                            │
│   ОрганизацииБезКлюча: [...]               │
│   ОшибкиПоДокументам: {...}                │
│ }                                          │
└────────────┬───────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────┐
│ СформироватьОтчетРезультатов()             │
│ Создание текстового отчета                 │
└────────────┬───────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────┐
│ Отображение модального окна с отчетом:     │
│                                            │
│ "Результаты получения статусов Диадок"     │
│ Всего документов: 10                       │
│ Успешно обработано: 7                      │
│ С ошибками: 3                              │
│                                            │
│ Организации без API-ключа:                 │
│   - ООО Тест (2 документа)                │
└────────────┬───────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────┐
│ Автоматическое обновление списка:          │
│ Форма.Элементы.Список.Обновить()           │
└────────────────────────────────────────────┘
```

---

## Настройка и конфигурация

### Требования к настройке системы

#### 1. План видов характеристик "ДополнительныеРеквизитыИСведения"

Необходимо создать следующие характеристики с `ИдентификаторДляФормул`:

| Наименование | ИдентификаторДляФормул | Тип значения | Назначение |
|-------------|------------------------|--------------|------------|
| Дата получения статуса | `ДатаПолученияСтатуса` | Дата | Для документов |
| Статус Диадок | `СтатусДиадок` | Строка(250) | Для документов |
| Идентификатор документа в Диадок | `ИдентификаторДокументаВДиадок` | Строка(250) | Для документов |
| Идентификатор ящика документа в Диадок | `ИдентификаторЯщикДокументаВДиадок` | Строка(250) | Для документов |
| **MRS_Ключ разработчика Диадок** | `MRS_КлючРазработчикаДиадок` | Строка(250) | **Для организаций** |

**Важно**: Характеристика `MRS_КлючРазработчикаДиадок` должна быть доступна для объекта `Справочник.Организации`.

#### 2. Параметры сеанса

Создать параметры сеанса:
- `ЛогинДиадок` (Строка, неограниченная)
- `ПарольДиадок` (Строка, неограниченная)

#### 3. Регистр сведений "ДополнительныеСведения"

**Измерения**:
- `Объект` (Определяемый тип)
- `Свойство` (ПланВидовХарактеристикСсылка.ДополнительныеРеквизитыИСведения)

**Ресурсы**:
- `Значение` (Определяемый тип)

#### 4. Общий макет "БиблиотекаТекстов"

Макет должен содержать XML структуру с набором данных `КонвертацияBase64` для преобразования Base64:
- `Convert_Base64_to_Binary` - Соответствие символов Base64 к двоичным строкам
- `Convert_Binary_to_Hex` - Соответствие двоичных строк к шестнадцатеричным

#### 5. Общая картинка "ITS_ДиадокОбщаяКартинка"

Картинка для кнопок интеграции с Диадок (логотип или иконка).

### Конфигурирование API ключа

API ключ по умолчанию:
```bsl
Функция ПолучитьКлючРазработчикаПоУмолчанию()
    Возврат "1C";
КонецФункции
```

Для использования собственного ключа:
1. Зарегистрироваться в личном кабинете разработчика Диадок
2. Получить API ключ
3. Внести ключ для каждой организации в `РегистрСведений.ДополнительныеСведения`

### Права доступа

Модули используют привилегированный режим для работы с параметрами сеанса:

```bsl
Функция ПолучитьЛогинДиадок() Экспорт
    УстановитьПривилегированныйРежим(Истина);
    Попытка
        Результат = ПараметрыСеанса.ЛогинДиадок;
    Исключение
        Результат = "";
    КонецПопытки;
    УстановитьПривилегированныйРежим(Ложь);
    Возврат Результат;
КонецФункции
```

---

## Обработка ошибок

### Стратегия обработки ошибок

#### 1. Ошибки аутентификации

**Сценарий**: Неверные логин/пароль

**Обработка**:
```bsl
Если Найти(ТекстОтвета, "Wrong") > 0 Тогда
    Результат.ТекстОшибки = "Неверный логин или пароль";
    Возврат Результат;
КонецЕсли;
```

**Возвращаемая структура**:
```bsl
Результат = Новый Структура;
Результат.Вставить("Успех", Ложь);
Результат.Вставить("ТекстОшибки", "Неверный логин или пароль");
```

#### 2. Ошибки сетевого взаимодействия

**Сценарий**: Проблемы с подключением к API

**Обработка**:
```bsl
Попытка
    Соединение.ОтправитьДляОбработки(HTTPЗапрос, ФайлРезультата);
Исключение
    УдалитьФайлы(ФайлРезультата);
    Результат.ТекстОшибки = "Ошибка подключения к Диадок: " + ОписаниеОшибки();
    Возврат Результат;
КонецПопытки;
```

#### 3. Ошибки парсинга данных

**Сценарий**: Некорректный формат ответа API

**Обработка**:
```bsl
Попытка
    Статус_ = Статусы.Получить(СтруктураJson1.RecipientReceiptMetadata.ReceiptStatus);
Исключение
    Статус_ = "";
КонецПопытки;

Если Статус_ = Неопределено Тогда
    Статус_ = "";
КонецЕсли;
```

#### 4. Ошибки отсутствия данных

**Сценарий**: Документ не найден в Диадок

**Обработка**:
```bsl
Если НЕ ЗначениеЗаполнено(Документ) Тогда
    Возврат "";
КонецЕсли;
```

**Сценарий**: Отсутствуют идентификаторы в БД

```bsl
Если РезультатЗапроса.Пустой() Тогда
    Возврат "";
КонецЕсли;
```

#### 5. Ошибки конвертации идентификаторов

**Сценарий**: Некорректный формат адреса ящика

**Обработка**:
```bsl
Функция АдресЯщикаВИдентификатор(АдресЯщика) Экспорт
    ДлинаИД = СтрДлина(ИД);
    
    Если ДлинаИД = 32 Тогда
        // Обработка
    ИначеЕсли ДлинаИД = 36 Тогда
        // Обработка
    Иначе
        ТекстОшибки = ПодставитьПараметрыВСтроку(
            НСтр("ru = 'Некорректный адрес ящика %1'"), АдресЯщика);
        ВызватьИсключение ТекстОшибки;
    КонецЕсли;
КонецФункции
```

### Очистка временных файлов

Все временные файлы удаляются после использования:

```bsl
ФайлРезультата = ПолучитьИмяВременногоФайла();
Попытка
    Соединение.ОтправитьДляОбработки(HTTPЗапрос, ФайлРезультата);
    // Обработка
Исключение
    УдалитьФайлы(ФайлРезультата);
    ВызватьИсключение;
КонецПопытки;
УдалитьФайлы(ФайлРезультата);
```

### Обработка ошибок в мультиорганизационном режиме

#### 1. Организации без API-ключа

**Сценарий**: У организации отсутствует запись с `MRS_КлючРазработчикаДиадок` в регистре `ДополнительныеСведения`

**Обработка**:
```bsl
КлючРазработчика = ПолучитьКлючРазработчикаОрганизацииДокумента(ТекущаяОрганизация);

Если НЕ ЗначениеЗаполнено(КлючРазработчика) Тогда
    
    ЭлементОшибки = Новый Структура;
    ЭлементОшибки.Вставить("Организация", ТекущаяОрганизация);
    ЭлементОшибки.Вставить("Наименование", Строка(ТекущаяОрганизация));
    ЭлементОшибки.Вставить("КоличествоДокументов", МассивДокументов.Количество());
    
    СтруктураРезультатов.ОрганизацииБезКлюча.Добавить(ЭлементОшибки);
    СтруктураРезультатов.СОшибками = СтруктураРезультатов.СОшибками + МассивДокументов.Количество();
    
    Продолжить; // Пропустить обработку документов этой организации
    
КонецЕсли;
```

**Отчет для пользователя**:
```
Организации без API-ключа Диадок:
  - ООО "Мрия-Торг" (5 документов)
  - ООО "БизнесПартнер" (3 документа)

Для настройки API-ключа обратитесь к администратору системы.
```

#### 2. Документы без идентификаторов Диадок

**Сценарий**: У документа отсутствуют `ИдентификаторДокументаВДиадок` или `ИдентификаторЯщикДокументаВДиадок`

**Обработка**:
```bsl
Если НЕ ЗначениеЗаполнено(ИдентификаторДокументаВДиадок) 
    ИЛИ НЕ ЗначениеЗаполнено(ИдентификаторЯщикДокументаВДиадок) Тогда
    
    СтруктураРезультатов.ДокументыБезИдентификаторов.Добавить(ТекущийДокумент);
    СтруктураРезультатов.СОшибками = СтруктураРезультатов.СОшибками + 1;
    
    Продолжить; // Пропустить обработку документа
    
КонецЕсли;
```

**Отчет для пользователя**:
```
Документы без идентификаторов Диадок: 2
  - Поступление товаров и услуг №00000123 от 15.10.2024
  - Поступление товаров и услуг №00000125 от 16.10.2024
```

#### 3. Ошибки при получении статуса конкретного документа

**Сценарий**: API Диадок вернул ошибку или произошел сбой при обработке

**Обработка**:
```bsl
Попытка
    Статус = ПолучитьСтруктуруДокументаПоAPIДиадок(...);
    
    Если ЗначениеЗаполнено(Статус) Тогда
        СохранитьСтатусДокумента(Статус, ТекущийДокумент);
        СтруктураРезультатов.УспешноОбработано = СтруктураРезультатов.УспешноОбработано + 1;
    Иначе
        СтруктураРезультатов.ОшибкиПоДокументам.Вставить(ТекущийДокумент, "Не удалось получить статус");
        СтруктураРезультатов.СОшибками = СтруктураРезультатов.СОшибками + 1;
    КонецЕсли;
    
Исключение
    ТекстОшибки = ОписаниеОшибки();
    СтруктураРезультатов.ОшибкиПоДокументам.Вставить(ТекущийДокумент, ТекстОшибки);
    СтруктураРезультатов.СОшибками = СтруктураРезультатов.СОшибками + 1;
КонецПопытки;
```

**Отчет для пользователя** (первые 10 ошибок):
```
Ошибки по документам:
  - Поступление товаров и услуг №00000130: Ошибка подключения к API
  - Поступление товаров и услуг №00000131: Документ не найден в Диадок
  - Поступление товаров и услуг №00000132: Таймаут соединения
  ... и еще 7 ошибок
```

#### 4. Категории ошибок массовой обработки

| Категория | Счетчик | Действие |
|-----------|---------|----------|
| Организации без API-ключа | `ОрганизацииБезКлюча.Количество()` | Добавить ключ через РегистрСведений |
| Документы без идентификаторов | `ДокументыБезИдентификаторов.Количество()` | Создать документ в Диадок через внешний интерфейс |
| Ошибки API | `ОшибкиПоДокументам.Количество()` | Проверить сетевое подключение, статус API Диадок |
| Всего с ошибками | `СОшибками` | Общий счетчик ошибок |
| Успешно обработано | `УспешноОбработано` | Документы с обновленным статусом |

#### 5. Структура отчета для пользователя

Функция `СформироватьОтчетРезультатовОбработки()` формирует текстовый отчет:

```bsl
ТекстОтчета = 
"────────────────────────────────────────
Результаты получения статусов Диадок
────────────────────────────────────────

Всего документов: 25
Успешно обработано: 18
С ошибками: 7

" + ?(ОрганизацииБезКлюча.Количество() > 0, 
"
Организации без API-ключа Диадок:
  - ООО Тест (5 документов)
  
Для настройки обратитесь к администратору.
", "") +

// ... дополнительные секции
```

Отчет ограничивается первыми 10 ошибками для читаемости.

---

## Приложения

### Приложение А: Примеры использования

#### Пример 1: Добавление интеграции в новую форму документа

```bsl
#Область ОбработчикиСобытийФормы

&После("ПриСозданииНаСервере")
Процедура MRS_ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    MRS_ИнтеграцияДиадокКлиентСервер.ДополнитьФормуИнтеграциейДиадок(ЭтотОбъект);
КонецПроцедуры

#КонецОбласти

#Область ИнтеграцияДиадок

&НаКлиенте
Процедура ДиадокПерейтиВЛичныйКабинет(Команда)
    Ссылка = Объект.Ссылка;
    MRS_ИнтеграцияДиадокКлиент.ПерейтиКДокументуДиадок(ЭтотОбъект, Ссылка);
КонецПроцедуры

&НаКлиенте
Процедура ДиадокПолучитьСтатус(Команда)
    Ссылка = Объект.Ссылка;
    MRS_ИнтеграцияДиадокКлиент.ПолучитьСтатусДокументаДиадок(ЭтотОбъект, Ссылка);
КонецПроцедуры

#КонецОбласти
```

#### Пример 2: Программное получение статуса

```bsl
Процедура ПолучитьСтатусыДокументовЗаПериод(НачалоПериода, КонецПериода)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ПриобретениеТоваровУслуг.Ссылка КАК Ссылка
    |ИЗ
    |    Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
    |ГДЕ
    |    ПриобретениеТоваровУслуг.Дата МЕЖДУ &НачалоПериода И &КонецПериода
    |    И ПриобретениеТоваровУслуг.Проведен";
    
    Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
    Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
    
    Выборка = Запрос.Выполнить().Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        Статус = MRS_ИнтеграцияДиадокСервер.ПолучитьСтруктуруДокументаПоAPIДиадок(
            ЛогинДиадок, ПарольДиадок, КлючРазработчика, Выборка.Ссылка);
        
        Если ЗначениеЗаполнено(Статус) Тогда
            MRS_ИнтеграцияДиадокСервер.СохранитьСтатусДокумента(Статус, Выборка.Ссылка);
        КонецЕсли;
        
    КонецЦикла;
    
КонецПроцедуры
```

#### Пример 3: Получение URL документа

```bsl
Функция ПолучитьСсылкуНаДокумент(Документ)
    
    ЛогинДиадок = MRS_ИнтеграцияДиадокСервер.ПолучитьЛогинДиадок();
    ПарольДиадок = MRS_ИнтеграцияДиадокСервер.ПолучитьПарольДиадок();
    КлючРазработчика = MRS_ИнтеграцияДиадокСервер.ПолучитьКлючРазработчикаДиадок();
    
    URL = MRS_ИнтеграцияДиадокСервер.ПолучитьСсылкуНаДокументДиадок(
        ЛогинДиадок, ПарольДиадок, КлючРазработчика, Документ);
    
    Возврат URL;
    
КонецФункции
```

#### Пример 4: Массовое получение статусов

```bsl
// В форме списка документов
&НаКлиенте
Процедура ДиадокПолучитьСтатус(Команда)
    
    // Сбор выделенных документов
    МассивДокументов = Новый Массив;
    
    Для Каждого ВыделеннаяСтрока Из Элементы.СписокДокументыЗакупки.ВыделенныеСтроки Цикл
        
        ДанныеСтроки = Элементы.СписокДокументыЗакупки.ДанныеСтроки(ВыделеннаяСтрока);
        Если ТипЗнч(ДанныеСтроки.Ссылка) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда
            МассивДокументов.Добавить(ДанныеСтроки.Ссылка);
        КонецЕсли;
        
    КонецЦикла;
    
    // Массовая обработка
    MRS_ИнтеграцияДиадокКлиент.ПолучитьСтатусДокументаДиадок(ЭтотОбъект, МассивДокументов);
    
КонецПроцедуры
```

**Результат**:
- Документы автоматически группируются по организациям
- Для каждой организации используется свой API-ключ
- Пользователь получает детальный отчет о результатах
- Список автоматически обновляется после обработки

### Приложение Б: FAQ

**Q: Как часто обновляются статусы документов?**
A: Статусы обновляются только при явном запросе пользователя через кнопку "Получить статус". Для автоматического обновления необходимо реализовать регламентное задание.

**Q: Можно ли использовать несколько учетных записей Диадок?**
A: Текущая реализация поддерживает только одну учетную запись в рамках сеанса пользователя. Параметры сеанса хранят данные одной учетной записи.

**Q: Как обрабатываются документы без идентификаторов Диадок?**
A: Если у документа отсутствуют идентификаторы в регистре `ДополнительныеСведения`, методы возвращают пустую строку без генерации ошибки.

**Q: Поддерживается ли отправка документов в Диадок?**
A: Нет, текущая реализация поддерживает только чтение статусов и переход к документам. Отправка должна быть реализована отдельно.

**Q: Как работает кэширование токенов?**
A: Токены не кэшируются. При каждом запросе к API выполняется новая аутентификация через `/Authenticate`.

**Q: Как настроить API-ключи для разных организаций?**
A: API-ключи настраиваются через `РегистрСведений.ДополнительныеСведения` с использованием характеристики `MRS_КлючРазработчикаДиадок`. Необходимо создать запись для каждой организации с соответствующим ключом.

**Q: Что происходит, если у организации нет API-ключа?**
A: Документы этой организации пропускаются при обработке, а в отчете указывается количество пропущенных документов. Пользователю рекомендуется обратиться к администратору для настройки ключа.

**Q: Можно ли обработать документы разных типов одновременно?**
A: Да, функция `ПолучитьОрганизацииДокументов()` использует динамический запрос, который автоматически определяет типы документов в массиве и извлекает их организации.

**Q: Сколько документов можно обработать за один раз?**
A: Технически ограничений нет, но рекомендуется обрабатывать не более 100-200 документов за один запрос для оптимальной производительности. При большем количестве возрастает время обработки и вероятность таймаутов.

**Q: Как работает проверка авторизации без глобального API-ключа?**
A: При проверке учетных данных система использует функцию `ПолучитьКлючДляПроверкиАвторизации()`, которая:
- Находит первый доступный API-ключ из любой организации в базе
- Если ключи не настроены, использует стандартный ключ "1C"
- Это позволяет проверить логин/пароль пользователя без необходимости выбирать конкретную организацию

**Q: Почему форма авторизации открывается модально?**
A: Модальное окно (`РежимОткрытияОкнаФормы.БлокироватьОкноВладельца`):
- Открывается компактно по центру родительского окна (не на весь экран)
- Блокирует работу с родительской формой до ввода данных
- Обеспечивает лучший UX для диалогов ввода данных
- Автоматически подстраивает размер под содержимое

**Q: Что такое ключ "1C" и можно ли его использовать в production?**
A: "1C" - это стандартный API-ключ от СКБ Контур для базовых интеграций 1С. Он используется как fallback, если в системе не настроены индивидуальные ключи. Для production-среды рекомендуется:
- Получить собственный API-ключ в личном кабинете разработчика Диадок (https://developer.kontur.ru/)
- Настроить индивидуальный ключ для каждой организации
- Стандартный ключ "1C" имеет ограничения по нагрузке и может использоваться только для тестирования

---

## Контакты и поддержка

**Разработчик**: MRIYA ERP Extensions - Alexwy Shvetsov
**Email**: support@example.com

**Полезные ссылки**:
- [Документация API Диадок](https://developer.kontur.ru/doc/diadoc-api/)
- [OpenAPI спецификация Диадок](https://www.diadoc.ru/articles/81279)
- [Личный кабинет Диадок](https://diadoc.kontur.ru/)

---
