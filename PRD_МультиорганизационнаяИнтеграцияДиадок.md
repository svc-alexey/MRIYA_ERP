# PRD: Мультиорганизационная работа с API Диадок

## Название
Поддержка множественных организаций с индивидуальными API-ключами при работе с Диадок

---

## Контекст & Цели

### Проблема
Текущая реализация интеграции с Диадок использует единый API-ключ разработчика для всех организаций. В реальных условиях каждая организация может иметь собственный ключ разработчика для доступа к API Диадок. При массовой обработке документов из формы списка могут быть выбраны документы разных организаций, или один документ,  что требует использования соответствующих ключей API для каждой организации.

### Фоновая информация
- База: 1С:ERP 2.5.17.103 (кастомизированная)
- Платформа: 1С:Предприятие 8.3.24
- Существующая интеграция: модули MRS_ИнтеграцияДиадок*
- Ключ разработчика хранится: в РегистрСведений.ДополнительныеСведения для каждой Организации
- Точки вызова: формы документов, форма списка документов (ЖурналДокументовЗакупки)

### Цели
- Обеспечить корректную работу с API Диадок для документов разных организаций
- Обрабатывать ситуации отсутствия API-ключа у организации 
- Отображать статус обработки и ошибки для каждого документа в списке
- Программно выводить статус документа Диадок на форму списка документов

### Не входит в границы задачи (Out of scope)
- Изменение логики аутентификации пользователя в Диадок
- Автоматическое создание/регистрация API-ключей
- Массовая загрузка API-ключей для организаций
- Автоматическое обновление статусов по расписанию
- Отправка документов в Диадок

---

## Основные функции

### 1. Определение организаций выбранных документов
При нажатии кнопки получения статуса система должна:
- Извлечь список всех выбранных документов или одногоиз формы списка или формы документа
- Определить организацию для каждого документа
- Сгруппировать документы по организациям

### 2. Получение API-ключей организаций
Для каждой уникальной организации:
- Получить ключ разработчика из РегистрСведений.ДополнительныеСведения
- Идентификатор свойства: `MRS_КлючРазработчикаДиадок`
- Отфильтровать записи с условием `НЕ Значение ПОДОБНО "усл:%"`

### 3. Массовая обработка запросов
- Отправить запросы к API Диадок для каждой группы документов
- Использовать соответствующий API-ключ для каждой организации
- Обработать ответы и обновить статусы документов

### 4. Программное отображение статусов на форме списка
- Обновить колонку `СтатусЭДО` в динамическом списке после получения статусов
- Отобразить индикатор обработки для каждого документа
- Показать статус синхронизации (успех/ошибка) визуально

### 5. Обработка ошибок и уведомления
Информировать пользователя о:
- Организациях без API-ключа
- Организациях, к которым нет доступа
- Ошибках при получении статусов
- Успешно обработанных документах

---

## Детальные потоки (Flows)

### Поток 1: Получение статуса для множественных документов

**Шаг 1: Инициация запроса**
- Пользователь выбирает один или несколько документов в журнале документов закупки
- Нажимает кнопку "Получить статус" (`ДиадокПолучитьСтатус`)
- Клиентский модуль собирает массив ссылок на документы

**Шаг 2: Извлечение организаций (серверный вызов)**
- Передать массив документов на сервер
- Выполнить запрос для получения организаций каждого документа
- Запрос: `ВЫБРАТЬ Ссылка, Организация ИЗ Документ.* ГДЕ Ссылка В (&МассивДокументов)`
- Сформировать соответствие: `СоответствиеДокументОрганизация`

**Шаг 3: Группировка по организациям**
- Создать структуру: `Организация -> Массив(Документы)`
- Для каждой уникальной организации создать отдельную группу документов

**Шаг 4: Получение API-ключей**
- Для каждой организации вызвать процедуру `ПолучитьКлючРазработчикаОрганизацииДокумента(Организация)`
- Если ключ не найден: добавить организацию в список ошибок, пропустить её документы
- Сформировать соответствие: `Организация -> API_Ключ`

**Шаг 5: Аутентификация в Диадок**
- Для каждой организации с валидным API-ключом:
- Вызвать `POST /Authenticate` с использованием:
  - Логин пользователя (из параметров сеанса)
  - Пароль пользователя (из параметров сеанса)
  - API-ключ организации
- Получить токен для дальнейших запросов
- Если аутентификация не удалась: добавить в список ошибок

**Шаг 7: Массовое получение статусов**
- Для каждого документа в группе организации:
  - Получить идентификаторы документа (boxId, messageId, entityId)
  - Отправить `GET /V3/GetDocument`
  - Парсить JSON ответ
  - Извлечь статус из `RecipientReceiptMetadata.ReceiptStatus` или `DocflowStatus.PrimaryStatus.StatusText`
  - Сохранить статус в РегистрСведений.ДополнительныеСведения
  - Обновить дату получения статуса

**Шаг 8: Программное обновление формы списка**
- Вызвать метод обновления динамического списка: `Элементы.СписокДокументыЗакупки.Обновить()`
- Подсветить обработанные строки (успех/ошибка)
- Обновить колонку `СтатусЭДО` для всех обработанных документов
- Установить видимость индикаторов обработки

**Шаг 9: Формирование отчета результатов**
- Подсчитать статистику:
  - Всего документов: N
  - Успешно обработано: X
  - Ошибок: Y
  - Организаций без API-ключа: Z
  - Организаций без доступа: W
- Сформировать текст сообщения для пользователя
- Вывести детализацию по ошибкам (список организаций с проблемами)

**Шаг 10: Уведомление пользователя**
- Вывести модальное окно с результатами обработки
- Показать список проблемных организаций
- Предложить действия для устранения проблем (настроить API-ключ, запросить доступ)

### Поток 2: Программное отображение статуса в списке

**Шаг 1: Обновление данных списка**
- После получения статусов для документов
- Вызвать `Элементы.СписокДокументыЗакупки.Обновить()` для перечитывания данных

**Шаг 2: Визуальное оформление статусов**
- Колонка `СтатусЭДО` отображает текстовое представление статуса
- Колонка `СозданВДиадок` показывает булевое значение (флажок)
- При необходимости использовать условное оформление для разных типов статусов

**Шаг 3: Индикация процесса обработки**
- Во время выполнения запросов показывать индикатор загрузки
- Временно блокировать список от изменений
- После завершения снять блокировку

### Поток 3: Обработка ошибок

**Сценарий 3.1: Отсутствие API-ключа у организации**
- Логика: При вызове `ПолучитьКлючРазработчикаОрганизацииДокумента()` возвращается пустое значение
- Действие:
  - Добавить организацию в структуру ошибок
  - Пропустить все документы этой организации
  - В итоговом отчете указать: "Организация <Наименование> не имеет настроенного API-ключа Диадок"
  - Предложить ссылку на инструкцию по настройке


**Сценарий 3.2: Ошибка аутентификации**
- Логика: API Диадок возвращает ошибку при аутентификации
- Возможные причины: неверный API-ключ, проблемы с сетью, блокировка аккаунта
- Действие:
  - Логировать ошибку с деталями ответа
  - В итоговом отчете: "Ошибка доступа к API Диадок для организации <Наименование>: <текст ошибки>"
  - Проверить корректность сохраненного API-ключа

**Сценарий 3.3: Отсутствие идентификаторов документа в Диадок**
- Логика: У документа не заполнены свойства `ИдентификаторДокументаВДиадок` или `ИдентификаторЯщикДокументаВДиадок`
- Действие:
  - Пропустить документ (не отправлять запрос к API)
  - Не считать ошибкой (документ просто не загружен в Диадок)
  - В итоговом отчете: "Документы без идентификаторов Диадок: N шт"

**Сценарий 3.4: Сетевая ошибка**
- Логика: Таймаут соединения, недоступность API
- Действие:
  - Перехватить исключение в блоке `Попытка...Исключение`
  - Логировать полный текст ошибки
  - В итоговом отчете: "Ошибка подключения к API Диадок: <описание>"
  - Предложить повторить попытку позже

---

## Данные & Интеграции

### Основные сущности

**1. Документ (определяемый тип)**
- Атрибуты:
  - Ссылка (уникальный идентификатор)
  - Организация (СправочникСсылка.Организации)
  - Номер, Дата (для отображения пользователю)

**2. Организация (Справочник.Организации)**
- Используется для:
  - Группировки документов
  - Получения API-ключа из дополнительных сведений
  - Проверки прав доступа

**3. Дополнительные сведения (РегистрСведений.ДополнительныеСведения)**
- Измерения:
  - Объект (Справочник.Организации или документ)
  - Свойство (ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения)
- Ресурсы:
  - Значение (определяемый тип)
- Ключевые свойства:
  - `MRS_КлючРазработчикаДиадок` - API ключ организации (для Объект = Организация)
  - `ИдентификаторДокументаВДиадок` - ID документа в Диадок (для Объект = Документ)
  - `ИдентификаторЯщикДокументаВДиадок` - ID ящика (для Объект = Документ)
  - `СтатусДиадок` - текущий статус документа (для Объект = Документ)
  - `ДатаПолученияСтатуса` - дата последнего обновления (для Объект = Документ)

**4. Параметры сеанса**
- `ЛогинДиадок` - логин пользователя в Диадок
- `ПарольДиадок` - пароль пользователя в Диадок
- Примечание: API-ключ организации НЕ хранится в параметрах сеанса

### Структуры данных для обработки

**СтруктураРезультатовОбработки:**
```
- ВсегоДокументов (Число)
- УспешноОбработано (Число)
- СОшибками (Число)
- ОрганизацииБезКлюча (Массив из Структура)
  - Организация (СправочникСсылка)
  - Наименование (Строка)
  - КоличествоДокументов (Число)
- ОрганизацииБезДоступа (Массив из Структура)
  - Организация (СправочникСсылка)
  - Наименование (Строка)
  - КоличествоДокументов (Число)
- ДокументыБезИдентификаторов (Массив из ДокументСсылка)
- ОшибкиПоДокументам (Соответствие: Документ -> ТекстОшибки)
```

**СоответствиеОрганизацияДокументы:**
```
Ключ: СправочникСсылка.Организации
Значение: Массив из ДокументСсылка
```

**СоответствиеОрганизацияAPI:**
```
Ключ: СправочникСсылка.Организации
Значение: Структура
  - КлючРазработчика (Строка)
  - Токен (Строка, после аутентификации)
```

### Внешние системы

**API Диадок**
- Базовый URL: `https://diadoc-api.kontur.ru`
- Эндпоинты:
  - `POST /Authenticate` - аутентификация
  - `GET /V3/GetDocument` - получение документа
- Аутентификация: заголовок `Authorization: DiadocAuth ddauth_api_client_id={key},ddauth_token={token}`
- Формат: JSON
- Таймаут: 60 секунд

---

## Метаданные

### Новые объекты (с префиксом MRS)

Новых объектов метаданных не требуется - используются существующие.

### Изменения существующих объектов

**1. CommonModule.MRS_ИнтеграцияДиадокСервер**
- Новая процедура: `ПолучитьСтатусыДокументовМассово(МассивДокументов) Экспорт`
- Новая функция: `ПолучитьОрганизацииДокументов(МассивДокументов) Экспорт`
- Модификация: `ПолучитьКлючРазработчикаОрганизацииДокумента()` - уже реализована

**2. CommonModule.MRS_ИнтеграцияДиадокКлиент**
- Модификация процедуры: `ПолучитьСтатусДокументаДиадок(Форма, Документы)`
  - Добавить поддержку массива документов
  - Добавить обработку ошибок по организациям
  - Добавить формирование итогового отчета
- Новая процедура: `ОбновитьСтатусыВСписке(Форма, МассивДокументов)`

**3. CommonModule.MRS_ИнтеграцияДиадокКлиентСервер**
- Новая функция: `СформироватьОтчетРезультатовОбработки(СтруктураРезультатов) Экспорт`
- Новая функция: `ПолучитьТекстОшибкиПоКоду(КодОшибки) Экспорт`

**4. DataProcessor.ЖурналДокументовЗакупки.Form.СписокДокументов**
- Модификация процедуры: `ДиадокПолучитьСтатус()`
  - Передача массива документов в клиентский модуль
  - Обновление списка после обработки
- Новая процедура: `ОбновитьОтображениеСтатусов()`

### Используемые существующие объекты

**РегистрСведений.ДополнительныеСведения**
- Измерения: Объект, Свойство
- Ресурсы: Значение

**ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения**
- Используемые характеристики:
  - `MRS_КлючРазработчикаДиадок` (ИдентификаторДляФормул)
  - `ИдентификаторДокументаВДиадок`
  - `ИдентификаторЯщикДокументаВДиадок`
  - `СтатусДиадок`
  - `ДатаПолученияСтатуса`

**Справочник.Организации**
- Реквизиты: стандартные
- Используется: для группировки документов и хранения API-ключей

**Параметры сеанса**
- `ЛогинДиадок` (Строка)
- `ПарольДиадок` (Строка)
- `КлючРазработчикаДиадок` - НЕ используется (заменен на индивидуальные ключи организаций)

---

## Приоритеты (MoSCoW)

### Must Have (Обязательно)
- Получение API-ключа для каждой организации из дополнительных сведений
- Группировка документов по организациям
- Массовая обработка документов с использованием соответствующих API-ключей
- Обработка ошибок отсутствия API-ключа
- Обновление статусов в базе данных
- Программное обновление формы списка после получения статусов
- Вывод итогового отчета пользователю

### Should Have (Желательно)
- Детальная обработка всех типов ошибок
- Визуальное выделение обработанных строк в списке
- Индикатор прогресса при длительной обработке
- Отображение количества успешных/неуспешных операций

### Could Have (Опционально)
- Логирование всех операций в журнал регистрации
- Возможность повторной обработки только ошибочных документов
- Фоновое выполнение для большого количества документов
- Экспорт отчета об ошибках в файл
- Настройка таймаутов для API запросов

### Won't Have (Не включено в текущую версию)
- Автоматическая регистрация API-ключей в Диадок
- Автоматическое обновление статусов по расписанию
- Уведомления об изменении статусов
- Интеграция с другими ЭДО (не Диадок)
- Отправка документов в Диадок

---

## Правила валидации

### Входные данные

**Массив документов:**
- Не должен быть пустым
- Все элементы должны быть валидными ссылками
- Максимальное количество: 100 документов за один запрос

**API-ключ организации:**
- Строка, не пустая
- Не должна начинаться с "усл:" (условный ключ)
- Длина: от 1 до 250 символов

**Параметры сеанса:**
- ЛогинДиадок: обязательное, строка
- ПарольДиадок: обязательное, строка

### Бизнес-правила

**BR-1:** Если у документа не заполнена организация - пропустить с ошибкой

**BR-2:** Если у организации нет API-ключа - пропустить все её документы, добавить в отчет

**BR-4:** Если у документа нет идентификаторов Диадок - пропустить без ошибки (считать как "не в Диадок")

**BR-5:** Статус документа обновляется только при успешном ответе от API

**BR-6:** Дата получения статуса всегда обновляется при попытке получения (даже при ошибке)

---

## Пользовательский интерфейс (текстовое описание)

### Форма списка документов (ЖурналДокументовЗакупки)

**Существующие элементы:**
- Динамический список `СписокДокументыЗакупки`
- Колонка `СтатусЭДО` (Строка, 250) - отображает текстовый статус
- Колонка `СозданВДиадок` (Булево) - флажок наличия в Диадок
- Кнопка `ДиадокПолучитьСтатус` - группа кнопок Диадок

**Изменения поведения:**
- При нажатии кнопки "Получить статус":
  - Показать индикатор загрузки
  - Заблокировать список от редактирования
  - После завершения разблокировать список
  - Автоматически обновить отображение списка
  - Показать модальное окно с результатами

**Модальное окно результатов:**
- Заголовок: "Результаты обработки статусов Диадок"
- Поля:
  - Всего документов: N
  - Успешно обработано: X (зеленым цветом)
  - С ошибками: Y (красным цветом)
- Группа "Организации без API-ключа" (если есть):
  - Таблица: Наименование организации | Количество документов
- Группа "Организации без доступа" (если есть):
  - Таблица: Наименование организации | Количество документов
- Группа "Документы без идентификаторов" (если есть):
  - Количество: N
- Кнопки:
  - "ОК" - закрыть окно
  - "Подробнее" (опционально) - показать детальный лог

### Условное оформление списка (Could Have)

**Для колонки СтатусЭДО:**
- Статус "Документооборот завершен" - зеленый текст
- Статус "Аннулирован" - серый текст
- Статус "Ошибка..." - красный текст
- Статус "Требуется..." - оранжевый текст
- Пустой статус - обычный текст

---

## Сценарии использования

### Сценарий 1: Массовое обновление статусов для одной организации

**Контекст:** Бухгалтер работает с документами одной организации за период

**Шаги:**
1. Открыть журнал документов закупки
2. Отфильтровать документы по организации "ООО Мрия"
3. Выбрать 10 документов (Ctrl+Click)
4. Нажать кнопку "Получить статус"
5. Форма запроса данных Диадок: ввести логин/пароль (если не в сеансе)
6. Система получает API-ключ организации "ООО Мрия"
7. Система отправляет 10 запросов к API Диадок
8. Обновляются статусы всех 10 документов
9. Список автоматически обновляется
10. Показывается окно: "Успешно обработано: 10"

**Ожидаемый результат:** Все статусы обновлены, колонка СтатусЭДО содержит актуальные данные

### Сценарий 2: Обновление статусов для нескольких организаций

**Контекст:** Менеджер работает с документами разных организаций

**Шаги:**
1. Открыть журнал документов закупки
2. Выбрать 5 документов "ООО Мрия" + 5 документов "ООО Бизнес"
3. Нажать кнопку "Получить статус"
4. Система определяет 2 организации
5. Получает API-ключи для каждой:
   - "ООО Мрия": ключ найден
   - "ООО Бизнес": ключ найден
6. Аутентификация в Диадок для каждой организации
7. Обработка документов группами
8. Обновление статусов
9. Окно результатов: "Всего: 10, Успешно: 10"

**Ожидаемый результат:** Документы обеих организаций обработаны корректно

### Сценарий 3: Обработка с ошибками (нет API-ключа)

**Контекст:** Пользователь выбрал документы, у одной организации нет ключа

**Шаги:**
1. Выбрать 3 документа "ООО Мрия" + 2 документа "ООО Тест"
2. Нажать "Получить статус"
3. Система обнаруживает:
   - "ООО Мрия": ключ есть
   - "ООО Тест": ключа нет
4. Обрабатываются только документы "ООО Мрия": 3 шт
5. Окно результатов:
   - Всего: 5
   - Успешно: 3
   - С ошибками: 2
   - Организации без API-ключа:
     - ООО Тест | 2 документа
6. Кнопка "ОК"

**Ожидаемый результат:** Частичная обработка, пользователь проинформирован о проблеме

### Сценарий 4: Нет прав доступа к организации

**Контекст:** Пользователь пытается получить статусы для организации, к которой нет доступа

**Шаги:**
1. Выбрать 5 документов "ООО Закрытая"
2. Нажать "Получить статус"
3. Система проверяет права доступа
4. Обнаружен запрет на работу с "ООО Закрытая"
5. Окно результатов:
   - Всего: 5
   - С ошибками: 5
   - Организации без доступа:
     - ООО Закрытая | 5 документов
   - Сообщение: "Обратитесь к администратору для получения прав"

**Ожидаемый результат:** Документы не обработаны, пользователь знает причину

---

## Предположения (Assumptions)

1. **Хранение API-ключей:** API-ключи организаций уже заполнены в РегистрСведений.ДополнительныеСведения

2. **Уникальность логина/пароля:** Все организации используют единые учетные данные пользователя (логин/пароль Диадок), но разные API-ключи разработчика

3. **Модель доступа:** Права доступа пользователя к организациям контролируются стандартным механизмом RLS 1С, дополнительной настройки не требуется

4. **Лимиты API:** API Диадок не имеет жестких лимитов на количество запросов в секунду для используемых операций (или эти лимиты не будут достигнуты при обработке до 100 документов)

5. **Синхронная обработка:** Обработка выполняется синхронно в клиент-серверном режиме (без фоновых заданий), т.к. количество документов ограничено 100 шт

6. **Идентификаторы документов:** У всех документов, требующих обновления статуса, уже заполнены свойства `ИдентификаторДокументаВДиадок` и `ИдентификаторЯщикДокументаВДиадок` (заполнены при первичной загрузке в Диадок другим механизмом)

7. **Стабильность сети:** Сетевое соединение с API Диадок стабильно, таймауты 60 секунд достаточны

8. **Формат ответа API:** Формат JSON ответа от API Диадок стабилен и соответствует документации (структура полей `RecipientReceiptMetadata` и `DocflowStatus` не изменится)

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| API-ключ не заполнен для большинства организаций | Средняя | Высокое | Предварительная инструкция для администраторов по заполнению ключей + валидация при настройке |
| Долгое время обработки большого количества документов (>50) | Высокая | Среднее | Ограничение на 100 документов, показ индикатора прогресса, рекомендация обрабатывать порциями |
| Изменение формата API Диадок | Низкая | Высокое | Версионирование API запросов (использование /V3/), мониторинг документации Диадок |
| Пользователи не понимают, почему часть документов не обработана | Средняя | Низкое | Подробные сообщения об ошибках, ссылки на инструкции, визуальное выделение проблемных документов |
| Блокировка аккаунта в Диадок из-за частых запросов | Низкая | Высокое | Соблюдение лимитов API, добавление задержек между запросами (Could Have) |
| Потеря данных при обновлении статусов (конфликт записи) | Низкая | Среднее | Использование транзакций при записи в регистр сведений |
| Права доступа настроены некорректно, пользователь видит организации без доступа | Средняя | Среднее | Проверка прав перед обработкой, информативные сообщения об ошибках прав |

---

## Критерии приемки

### Функциональные

**AC-1:** При выборе документов разных организаций и нажатии "Получить статус" система корректно группирует документы по организациям

**AC-2:** Для каждой организации используется её индивидуальный API-ключ из РегистрСведений.ДополнительныеСведения

**AC-3:** Документы организации без API-ключа пропускаются, информация о них отображается в итоговом отчете

**AC-4:** Документы организации, к которой нет прав доступа, пропускаются, информация отображается в отчете

**AC-5:** После успешного получения статуса, колонка СтатусЭДО в списке документов автоматически обновляется

**AC-6:** Модальное окно результатов содержит:
- Общую статистику (всего/успешно/ошибки)
- Список организаций без API-ключа (если есть)
- Список организаций без доступа (если есть)

**AC-7:** Статусы документов в базе данных обновляются только при успешном ответе от API

**AC-8:** Дата получения статуса обновляется для всех обработанных документов

### Нефункциональные

**AC-9:** Обработка до 10 документов одной организации занимает не более 15 секунд

**AC-10:** При обработке более 5 документов показывается индикатор загрузки

**AC-11:** Все ошибки обрабатываются gracefully (без "красного экрана" 1С)

**AC-12:** Текст сообщений об ошибках понятен пользователю без технической подготовки

### Технические

**AC-13:** Реализованы серверные процедуры:
- `ПолучитьСтатусыДокументовМассово()`
- `ПолучитьОрганизацииДокументов()`
- `ПроверитьДоступКОрганизации()`

**AC-14:** Существующая функция `ПолучитьКлючРазработчикаОрганизацииДокумента()` используется без изменений

**AC-15:** Не создано новых объектов метаданных (используются существующие модули и регистры)

**AC-16:** Обратная совместимость: существующий функционал получения статуса для одного документа продолжает работать

---

## Метрики успеха

### Метрики использования

**M-1:** Количество успешных массовых обработок в день: целевое значение >10

**M-2:** Средний процент успешно обработанных документов: целевое значение >85%

**M-3:** Количество организаций с настроенными API-ключами: целевое значение 100% от активных организаций

### Метрики производительности

**M-4:** Среднее время обработки одного документа: <2 секунды

**M-5:** Процент запросов с таймаутом: <1%

### Метрики качества

**M-6:** Количество ошибок из-за некорректной обработки прав доступа: 0

**M-7:** Процент документов с актуальными статусами (обновлены за последние 24 часа): >70%

---

## Зависимости

### Внутренние зависимости

**DEP-1:** Модуль `MRS_ИнтеграцияДиадокСервер` с реализованной функцией `ПолучитьКлючРазработчикаОрганизацииДокумента()`

**DEP-2:** План видов характеристик `ДополнительныеРеквизитыИСведения` с характеристикой `MRS_КлючРазработчикаДиадок`

**DEP-3:** Регистр сведений `ДополнительныеСведения` с возможностью записи

**DEP-4:** Параметры сеанса `ЛогинДиадок` и `ПарольДиадок` (заполняются через форму запроса)

### Внешние зависимости

**DEP-5:** Доступность API Диадок (https://diadoc-api.kontur.ru)

**DEP-6:** Валидные учетные данные пользователя в Диадок (логин/пароль)

**DEP-7:** Наличие интернет-соединения с доступом к HTTPS

---

## Техническая документация (ссылки)

- **Существующая техническая документация:** `ТехническаяДокументация_ИнтеграцияДиадок.md`
- **API Диадок:** https://developer.kontur.ru/doc/diadoc-api/
- **Метод GetDocument:** https://developer.kontur.ru/doc/diadoc-api/proto/Document.html

---

## Вопросы для уточнения (перед началом разработки)

**Q-1:** Какой максимальный лимит одновременной обработки документов устанавливать? (100)

**Q-2:** Нужно ли логировать все операции в журнал регистрации 1С? (нет)

**Q-3:** Как обрабатывать ситуацию, если у пользователя не заполнены параметры сеанса (логин/пароль) - запрашивать один раз за сеанс.

**Q-4:** Требуется ли фоновая обработка для большого количества документов? (да)

**Q-5:** Нужна ли возможность отмены длительной операции обработки? (да)

**Q-6:** Какой приоритет у условного оформления статусов в списке? (Currently: Could Have)

---

## История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2025-10-27 | Product Manager | Первая версия PRD |

---

## Приложения

### Приложение А: Пример структуры ошибок

```
СтруктураРезультатов = Новый Структура;
СтруктураРезультатов.Вставить("ВсегоДокументов", 15);
СтруктураРезультатов.Вставить("УспешноОбработано", 10);
СтруктураРезультатов.Вставить("СОшибками", 5);

МассивОргБезКлюча = Новый Массив;
ЭлементОшибки = Новый Структура("Организация, Наименование, КоличествоДокументов");
ЭлементОшибки.Организация = Справочники.Организации.НайтиПоНаименованию("ООО Тест");
ЭлементОшибки.Наименование = "ООО Тест";
ЭлементОшибки.КоличествоДокументов = 5;
МассивОргБезКлюча.Добавить(ЭлементОшибки);

СтруктураРезультатов.Вставить("ОрганизацииБезКлюча", МассивОргБезКлюча);
СтруктураРезультатов.Вставить("ОрганизацииБезДоступа", Новый Массив);
СтруктураРезультатов.Вставить("ДокументыБезИдентификаторов", Новый Массив);
```

### Приложение Б: Коды ошибок API Диадок

| Код HTTP | Описание | Действие системы |
|----------|----------|------------------|
| 401 | Unauthorized | Проверить логин/пароль, повторить аутентификацию |
| 403 | Forbidden | Проверить API-ключ организации |
| 404 | Not Found | Документ не найден в Диадок, пропустить |
| 429 | Too Many Requests | Добавить задержку, повторить позже |
| 500 | Internal Server Error | Логировать ошибку, пропустить документ |
| Timeout | Таймаут соединения | Увеличить таймаут или повторить позже |

---

**Конец документа**
